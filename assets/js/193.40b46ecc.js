(window.webpackJsonp=window.webpackJsonp||[]).push([[193],{1226:function(t,s,a){"use strict";a.r(s);var n=[function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("div",{staticClass:"content"},[n("h1",{attrs:{id:"_8-3-小程序发布"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_8-3-小程序发布","aria-hidden":"true"}},[t._v("#")]),t._v(" 8.3 小程序发布")]),n("p",[t._v("小程序的基本功能我们已经完成了，接下来要做的就是将小程序发布出去。")]),n("h2",{attrs:{id:"切换域名"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#切换域名","aria-hidden":"true"}},[t._v("#")]),t._v(" 切换域名")]),n("p",[t._v("我们一直使用 "),n("code",[t._v("http://larabbs.test")]),t._v(" 访问本地的接口，发布小程序的时候首先需要切换到正式域名，我们可以利用环境变量 "),n("code",[t._v("NODE_ENV")]),t._v(" 来解决。")]),n("p",[t._v("其实 "),n("code",[t._v("WePY")]),t._v(" 框架已经为我们准备好了测试及正式环境编译的脚本：")]),n("p",[t._v("打开 "),n("code",[t._v("package.json")]),t._v(" 我们会发现一些准备好的 "),n("code",[t._v("scripts")]),t._v("。")]),n("p",[n("em",[t._v("package.json")])]),n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[t._v("  "),n("span",{attrs:{class:"token string"}},[t._v('"scripts"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{attrs:{class:"token string"}},[t._v('"dev"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token string"}},[t._v('"wepy build --watch"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),n("span",{attrs:{class:"token string"}},[t._v('"build"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token string"}},[t._v('"cross-env NODE_ENV=production wepy build --no-cache"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),n("span",{attrs:{class:"token string"}},[t._v('"dev:web"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token string"}},[t._v('"wepy build --output web"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),n("span",{attrs:{class:"token string"}},[t._v('"clean"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token string"}},[t._v("\"find ./dist -maxdepth 1 -not -name 'project.config.json' -not -name 'dist' | xargs rm -rf\"")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),n("span",{attrs:{class:"token string"}},[t._v('"test"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token string"}},[t._v('"echo \\"Error: no test specified\\" && exit 1"')]),t._v("\n  "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n")])]),n("ul",[n("li",[t._v("执行 "),n("code",[t._v("npm run dev")]),t._v(" 相当于执行 "),n("code",[t._v("wepy build --watch")]),t._v("；")]),n("li",[t._v("执行 "),n("code",[t._v("npm run build")]),t._v(" 则会设置 "),n("code",[t._v("NODE_ENV=production")]),t._v(" 然后在进行无缓存（--no-cache） 的 "),n("code",[t._v("build")]),t._v("。")])]),n("p",[t._v("在 "),n("code",[t._v("wepy.config.js")]),t._v(" 中，可以通过"),n("code",[t._v("process.env.NODE_ENV")]),t._v(" 拿到不同的环境变量值。WePY 文档中也给出了一些建议的 "),n("a",{attrs:{href:"https://github.com/Tencent/wepy/wiki/WePY%E6%A0%B9%E6%8D%AE%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E6%9D%A5%E6%94%B9%E5%8F%98%E8%BF%90%E8%A1%8C%E6%97%B6%E7%9A%84%E5%8F%82%E6%95%B0",target:"_blank",rel:"noopener noreferrer"}},[t._v("方案")]),t._v("，我们使用 "),n("code",[t._v("replace")]),t._v(" 实现。")]),n("p",[t._v("假设我们正式上线的域名是 "),n("code",[t._v("https://weapp.laravel-china.org")]),t._v("。")]),n("blockquote",[n("p",[n("code",[t._v("https://weapp.laravel-china.org")]),t._v(" 这是我们准备的例子，你是无法直接使用的，如果你想上线自己的小程序，需要在自己的服务器上搭建 LaraBBS，同时备案域名。")])]),n("p",[t._v("安装生成环境编译需要的依赖：")]),n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("$ yarn add wepy-plugin-replace  wepy-plugin-imagemin  wepy-eslint \n")])]),n("p",[n("img",{attrs:{src:a(462),alt:"file"}})]),n("p",[t._v("修改 wepy.config.js：")]),n("p",[n("em",[t._v("wepy.config.js")])]),n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token keyword"}},[t._v("var")]),t._v(" prod "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" process"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("env"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token constant"}},[t._v("NODE_ENV")]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),n("span",{attrs:{class:"token string"}},[t._v("'production'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n  plugins"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    replace"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      filter"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token regex"}},[t._v("/\\.js$/")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      config"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        find"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token regex"}},[t._v("/__BASE_URL__/g")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        replace"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" prod "),n("span",{attrs:{class:"token operator"}},[t._v("?")]),t._v(" "),n("span",{attrs:{class:"token string"}},[t._v("\"'https://weapp.laravel-china.org/api'\"")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token string"}},[t._v("\"'http://larabbs.test/api'\"")]),t._v("\n      "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("prod"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),n("span",{attrs:{class:"token comment"}},[t._v("// 压缩sass")]),t._v("\n  "),n("span",{attrs:{class:"token comment"}},[t._v("// module.exports.compilers['sass'] = {outputStyle: 'compressed'}")]),t._v("\n\n  "),n("span",{attrs:{class:"token comment"}},[t._v("// 压缩js")]),t._v("\n  module"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("exports"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("plugins "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    uglifyjs"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    imagemin"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    replace"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      filter"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token regex"}},[t._v("/\\.js$/")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      config"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        find"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token regex"}},[t._v("/__BASE_URL__/g")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        replace"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" prod "),n("span",{attrs:{class:"token operator"}},[t._v("?")]),t._v(" "),n("span",{attrs:{class:"token string"}},[t._v("\"'https://weapp.laravel-china.org/api'\"")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token string"}},[t._v("\"'http://larabbs.test/api'\"")]),t._v("\n      "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),n("p",[t._v("这里使用了 "),n("a",{attrs:{href:"https://www.npmjs.com/package/wepy-plugin-replace",target:"_blank",rel:"noopener noreferrer"}},[t._v("wepy-plugin-replace")]),t._v(" 插件，替换所有 JS 文件中的 "),n("code",[t._v("__BASE_URL__")]),t._v("，根据当前的环境，如果是生产环境 prod 等于 true，则使用 "),n("code",[t._v("https://weapp.laravel-china.org/api")]),t._v("，否则使用 "),n("code",[t._v("http://larabbs.test/api")]),t._v("。")]),n("p",[t._v("现在我们可以在需要的地方直接使用 "),n("code",[t._v("__BASE_URL__")]),t._v(" 作为服务器接口地址了：")]),n("p",[n("em",[t._v("src/utils/api.js")])]),n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token keyword"}},[t._v("const")]),t._v(" host "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" __BASE_URL__\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n")])]),n("p",[t._v("修改原本 host 值为 "),n("code",[t._v("__BASE_URL__")]),t._v(" 即可，现在可以通过 "),n("code",[t._v("npm run dev")]),t._v("  和 "),n("code",[t._v("npm run build")]),t._v(" 编译不同环境的代码了。")]),n("h2",{attrs:{id:"配置服务器域名"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#配置服务器域名","aria-hidden":"true"}},[t._v("#")]),t._v(" 配置服务器域名")]),n("p",[t._v("登录"),n("a",{attrs:{href:"https://mp.weixin.qq.com/cgi-bin/bizlogin?action=validate&lang=zh_CN&account=liyularabbs%40gmail.com",target:"_blank",rel:"noopener noreferrer"}},[t._v("微信公众平台")]),t._v("，『进入设置』 -> 『开发设置』。\n"),n("img",{attrs:{src:a(461),alt:"file"}})]),n("p",[t._v("我们还没有设置服务器域名，点击开始配置。")]),n("p",[n("img",{attrs:{src:a(460),alt:"file"}})]),n("p",[t._v("填入 "),n("code",[t._v("request合法域名")]),t._v(" 和 "),n("code",[t._v("uploadFile合法域名")]),t._v("，注意这里微信要求我们域名必须使用 HTTPS，我们可以使用 "),n("a",{attrs:{href:"https://certbot.eff.org/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Certbot")]),t._v(" 等工具制作。")]),n("h2",{attrs:{id:"上传代码"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#上传代码","aria-hidden":"true"}},[t._v("#")]),t._v(" 上传代码")]),n("p",[t._v("使用 "),n("code",[t._v("npm run build")]),t._v(" 编译好一个正式环境的小程序之后，就可以将代码上传至微信服务器了。")]),n("p",[t._v("开发者工具的工具栏中有上传按钮。\n"),n("img",{attrs:{src:a(459),alt:"file"}})]),n("p",[t._v("输入版本号以及项目备注后即可上传到微信服务器了。\n"),n("img",{attrs:{src:a(458),alt:"file"}})]),n("p",[t._v("进入微信公众平台开发管理，可以在开发版本中看到刚才上传的代码了。\n"),n("img",{attrs:{src:a(457),alt:"file"}})]),n("p",[t._v("可以将当前版本设置为体验版本，这样就可以通过二维码分享给他人体验了。\n"),n("img",{attrs:{src:a(456),alt:"file"}})]),n("p",[n("img",{attrs:{src:a(455),alt:"file"}})]),n("h2",{attrs:{id:"提交审核"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#提交审核","aria-hidden":"true"}},[t._v("#")]),t._v(" 提交审核")]),n("p",[t._v("上传好了版本之后，如果想正式发布，让其他人可以搜索到小程序，那么就需要提交审核，将小程序上线。")]),n("ol",[n("li",[n("p",[t._v("填写小程序信息，登录"),n("a",{attrs:{href:"https://mp.weixin.qq.com/cgi-bin/bizlogin?action=validate&lang=zh_CN&account=liyularabbs%40gmail.com",target:"_blank",rel:"noopener noreferrer"}},[t._v("微信公众平台")]),t._v("，进入首页，点击小程序信息后面的填写按钮：\n"),n("img",{attrs:{src:a(454),alt:"file"}})])]),n("li",[n("p",[t._v("填写小程序的信息包括名称，头像，介绍：\n"),n("img",{attrs:{src:a(453),alt:"file"}})])]),n("li",[n("p",[t._v("填写完成后可以在 『设置』-> 『基本设置』 中看到填写的信息，可以再次修改，但是每个月有次数限制：\n"),n("img",{attrs:{src:a(452),alt:"file"}})])]),n("li",[n("p",[t._v("上传了小程序，填写完小程序信息后，便可以进入 『开发管理』，将开发版本提交审核了：")])])]),n("p",[n("img",{attrs:{src:a(451),alt:"file"}})]),n("ol",{attrs:{start:"5"}},[n("li",[n("p",[t._v("点击提交审核，勾选已阅读规则，点击下一步：\n"),n("img",{attrs:{src:a(450),alt:"file"}})])]),n("li",[n("p",[t._v("添加一个功能页面，补充完整小程序相关的信息，如下图所示：\n"),n("img",{attrs:{src:a(449),alt:"file"}})])]),n("li",[n("p",[t._v("提交审核成功：\n"),n("img",{attrs:{src:a(448),alt:"file"}})])])]),n("p",[t._v("提交审核成功后就会在『开发管理』-> 『审核版本』中看到待审核的版本了，接下来就是等待微信审核了，首次审核周期根据经验大概 7 天以内；以后的小版本审核大概 2 日左右。")]),n("blockquote",[n("p",[t._v("注意微信要求服务器域名需经过 ICP 备案，如果没有备案是审核不通过的。")])]),n("h2",{attrs:{id:"代码版本控制"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#代码版本控制","aria-hidden":"true"}},[t._v("#")]),t._v(" 代码版本控制")]),n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("$ "),n("span",{attrs:{class:"token function"}},[t._v("cd")]),t._v(" ~/Code/larabbs-weapp\n$ "),n("span",{attrs:{class:"token function"}},[t._v("git")]),t._v(" add -A\n$ "),n("span",{attrs:{class:"token function"}},[t._v("git")]),t._v(" commit -m "),n("span",{attrs:{class:"token string"}},[t._v("'switch env'")]),t._v("\n")])])])}],e=a(0),p=Object(e.a)({},function(){this.$createElement;this._self._c;return this._m(0)},n,!1,null,null,null);s.default=p.exports},448:function(t,s,a){t.exports=a.p+"assets/img/8.3_15.388035ad.png"},449:function(t,s,a){t.exports=a.p+"assets/img/8.3_14.30e71af2.png"},450:function(t,s,a){t.exports=a.p+"assets/img/8.3_13.b0116d4a.png"},451:function(t,s,a){t.exports=a.p+"assets/img/8.3_12.ead20730.png"},452:function(t,s,a){t.exports=a.p+"assets/img/8.3_11.24ea8e6c.png"},453:function(t,s,a){t.exports=a.p+"assets/img/8.3_10.f6a09e63.jpeg"},454:function(t,s,a){t.exports=a.p+"assets/img/8.3_9.55e10523.png"},455:function(t,s,a){t.exports=a.p+"assets/img/8.3_8.d6636821.png"},456:function(t,s,a){t.exports=a.p+"assets/img/8.3_7.c8122121.png"},457:function(t,s,a){t.exports=a.p+"assets/img/8.3_6.7505aa51.png"},458:function(t,s,a){t.exports=a.p+"assets/img/8.3_5.3f414a43.png"},459:function(t,s,a){t.exports=a.p+"assets/img/8.3_4.96fe3045.png"},460:function(t,s,a){t.exports=a.p+"assets/img/8.3_3.0b3f1a6e.png"},461:function(t,s,a){t.exports=a.p+"assets/img/8.3_2.12342c5c.png"},462:function(t,s,a){t.exports=a.p+"assets/img/8.3_1.55132e94.png"}}]);