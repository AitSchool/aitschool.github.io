(window.webpackJsonp=window.webpackJsonp||[]).push([[245],{1304:function(s,t,a){"use strict";a.r(t);var n=[function(){var s=this,t=s.$createElement,n=s._self._c||t;return n("div",{staticClass:"content"},[n("h1",{attrs:{id:"_7-3-用户角色"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_7-3-用户角色","aria-hidden":"true"}},[s._v("#")]),s._v(" 7.3 用户角色")]),n("p",[s._v("这个章节我们来处理用户角色的部分，客户端有可能在某些地方显示用户角色信息，例如某个用户的个人页面里，显示出用户是站长，还是管理员。用户的角色信息没必要在单独请求接口了，我们可以通过 Include 机制实现。")]),n("h2",{attrs:{id:"_1-增加-transformer"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-增加-transformer","aria-hidden":"true"}},[s._v("#")]),s._v(" 1. 增加  Transformer")]),n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("$ "),n("span",{attrs:{class:"token function"}},[s._v("touch")]),s._v(" app/Transformers/RoleTransformer.php\n")])]),n("p",[n("em",[s._v("app/Transformers/RoleTransformer.php")])]),n("pre",{pre:!0,attrs:{class:"language-php"}},[n("code",[n("span",{attrs:{class:"token php language-php"}},[n("span",{attrs:{class:"token delimiter important"}},[s._v("<?php")]),s._v("\n\n"),n("span",{attrs:{class:"token keyword"}},[s._v("namespace")]),s._v(" "),n("span",{attrs:{class:"token package"}},[s._v("App"),n("span",{attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("Transformers")]),n("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),n("span",{attrs:{class:"token keyword"}},[s._v("use")]),s._v(" "),n("span",{attrs:{class:"token package"}},[s._v("Spatie"),n("span",{attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("Permission"),n("span",{attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("Models"),n("span",{attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("Role")]),n("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{attrs:{class:"token keyword"}},[s._v("use")]),s._v(" "),n("span",{attrs:{class:"token package"}},[s._v("League"),n("span",{attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("Fractal"),n("span",{attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("TransformerAbstract")]),n("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),n("span",{attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),n("span",{attrs:{class:"token class-name"}},[s._v("RoleTransformer")]),s._v(" "),n("span",{attrs:{class:"token keyword"}},[s._v("extends")]),s._v(" "),n("span",{attrs:{class:"token class-name"}},[s._v("TransformerAbstract")]),s._v("\n"),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{attrs:{class:"token keyword"}},[s._v("function")]),s._v(" "),n("span",{attrs:{class:"token function"}},[s._v("transform")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("Role "),n("span",{attrs:{class:"token variable"}},[s._v("$role")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),n("span",{attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n            "),n("span",{attrs:{class:"token single-quoted-string string"}},[s._v("'id'")]),s._v(" "),n("span",{attrs:{class:"token operator"}},[s._v("=")]),n("span",{attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),n("span",{attrs:{class:"token variable"}},[s._v("$role")]),n("span",{attrs:{class:"token operator"}},[s._v("-")]),n("span",{attrs:{class:"token operator"}},[s._v(">")]),n("span",{attrs:{class:"token property"}},[s._v("id")]),n("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            "),n("span",{attrs:{class:"token single-quoted-string string"}},[s._v("'name'")]),s._v(" "),n("span",{attrs:{class:"token operator"}},[s._v("=")]),n("span",{attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),n("span",{attrs:{class:"token variable"}},[s._v("$role")]),n("span",{attrs:{class:"token operator"}},[s._v("-")]),n("span",{attrs:{class:"token operator"}},[s._v(">")]),n("span",{attrs:{class:"token property"}},[s._v("name")]),n("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),n("span",{attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])]),n("h2",{attrs:{id:"_2-修改-usertransformer"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-修改-usertransformer","aria-hidden":"true"}},[s._v("#")]),s._v(" 2. 修改 UserTransformer")]),n("p",[n("em",[s._v("app/Transformers/UserTransformer.php")])]),n("pre",{pre:!0,attrs:{class:"language-php"}},[n("code",[n("span",{attrs:{class:"token php language-php"}},[n("span",{attrs:{class:"token delimiter important"}},[s._v("<?php")]),s._v("\n\n"),n("span",{attrs:{class:"token keyword"}},[s._v("namespace")]),s._v(" "),n("span",{attrs:{class:"token package"}},[s._v("App"),n("span",{attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("Transformers")]),n("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),n("span",{attrs:{class:"token keyword"}},[s._v("use")]),s._v(" "),n("span",{attrs:{class:"token package"}},[s._v("App"),n("span",{attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("Models"),n("span",{attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("User")]),n("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{attrs:{class:"token keyword"}},[s._v("use")]),s._v(" "),n("span",{attrs:{class:"token package"}},[s._v("League"),n("span",{attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("Fractal"),n("span",{attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("TransformerAbstract")]),n("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),n("span",{attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),n("span",{attrs:{class:"token class-name"}},[s._v("UserTransformer")]),s._v(" "),n("span",{attrs:{class:"token keyword"}},[s._v("extends")]),s._v(" "),n("span",{attrs:{class:"token class-name"}},[s._v("TransformerAbstract")]),s._v("\n"),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{attrs:{class:"token keyword"}},[s._v("protected")]),s._v(" "),n("span",{attrs:{class:"token variable"}},[s._v("$availableIncludes")]),s._v(" "),n("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{attrs:{class:"token single-quoted-string string"}},[s._v("'roles'")]),n("span",{attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n"),n("span",{attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n    "),n("span",{attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{attrs:{class:"token keyword"}},[s._v("function")]),s._v(" "),n("span",{attrs:{class:"token function"}},[s._v("includeRoles")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("User "),n("span",{attrs:{class:"token variable"}},[s._v("$user")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),n("span",{attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),n("span",{attrs:{class:"token variable"}},[s._v("$this")]),n("span",{attrs:{class:"token operator"}},[s._v("-")]),n("span",{attrs:{class:"token operator"}},[s._v(">")]),n("span",{attrs:{class:"token function"}},[s._v("collection")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token variable"}},[s._v("$user")]),n("span",{attrs:{class:"token operator"}},[s._v("-")]),n("span",{attrs:{class:"token operator"}},[s._v(">")]),n("span",{attrs:{class:"token property"}},[s._v("roles")]),n("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),n("span",{attrs:{class:"token class-name"}},[s._v("RoleTransformer")]),n("span",{attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])]),n("p",[s._v("用户与角色的关系是一对多的，我们通过 "),n("code",[s._v("$this->collection")]),s._v(" 返回用户权限。")]),n("h2",{attrs:{id:"_3-postman-调试"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-postman-调试","aria-hidden":"true"}},[s._v("#")]),s._v(" 3. PostMan 调试")]),n("p",[n("img",{attrs:{src:a(638),alt:"file"}})]),n("p",[s._v("访问话题详情接口，修改参数为 "),n("code",[s._v("include=user.roles,category")]),s._v("，回忆一下 Include 机制，这里请求的是"),n("code",[s._v("话题资源")]),s._v("，"),n("code",[s._v("话题的发布用户信息")]),s._v("，"),n("code",[s._v("话题发布用户的角色资源")]),s._v("，"),n("code",[s._v("话题的分类资源")]),s._v("。")]),n("p",[s._v("可以看到结果中，用户信息数据中嵌套 roles 资源。任何一个需要用户资源的地方都可以通过 "),n("code",[s._v("include=roles")]),s._v(" 返回用户对应的角色，是不是非常的灵活方便。")]),n("h2",{attrs:{id:"代码版本控制"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#代码版本控制","aria-hidden":"true"}},[s._v("#")]),s._v(" 代码版本控制")]),n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("$ "),n("span",{attrs:{class:"token function"}},[s._v("git")]),s._v(" add -A\n$ "),n("span",{attrs:{class:"token function"}},[s._v("git")]),s._v(" commit -m "),n("span",{attrs:{class:"token string"}},[s._v("'include user roles'")]),s._v("\n")])])])}],r=a(0),e=Object(r.a)({},function(){this.$createElement;this._self._c;return this._m(0)},n,!1,null,null,null);t.default=e.exports},638:function(s,t,a){s.exports=a.p+"assets/img/7.3_1.eda0c739.png"}}]);