(window.webpackJsonp=window.webpackJsonp||[]).push([[249],{1310:function(t,s,a){"use strict";a.r(s);var n=[function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("div",{staticClass:"content"},[n("h1",{attrs:{id:"_6-6-标记通知为已读"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_6-6-标记通知为已读","aria-hidden":"true"}},[t._v("#")]),t._v(" 6.6 标记通知为已读")]),n("p",[t._v("我们还没有标记通知数据为已读，有些同学可能会在 "),n("code",[t._v("消息通知列表")]),t._v(" 接口中将所有未读消息标记为已读，只要调用了列表接口，就意味着消息已读。\n这么做看似没有什么问题，但是违背了一些原则，也带来了一些问题。回忆一下 "),n("a",{attrs:{href:"https://laravel-china.org/courses/laravel-advance-training-5.5/787/follow-github-to-learn-restful-http-api-design",target:"_blank",rel:"noopener noreferrer"}},[t._v("Github 的 Restful HTTP API 设计分解")]),t._v(" 这一节我们提到了 GET 是安全的请求。")]),n("blockquote",[n("p",[t._v("另外需要注意的是，GET 请求是安全的，不允许通过 GET 请求改变（更新或创建）资源。")])]),n("p",[n("code",[t._v("消息通知列表")]),t._v(" 接口是 GET 请求，不应该在这时候改变资源数据，而且客户端可能会有其他的方式标记已读，例如有个按钮 "),n("code",[t._v("标记所有通知为已读")]),t._v("。我们需要让接口符合规范，而且更加通用，所以一般需要客户端主动调用接口，来标记消息已读。")]),n("h2",{attrs:{id:"_1-增加路由"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-增加路由","aria-hidden":"true"}},[t._v("#")]),t._v(" 1. 增加路由")]),n("p",[n("em",[t._v("routes/api.php")])]),n("pre",{pre:!0,attrs:{class:"language-php"}},[n("code",[n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token comment"}},[t._v("// 通知统计")]),t._v("\n"),n("span",{attrs:{class:"token variable"}},[t._v("$api")]),n("span",{attrs:{class:"token operator"}},[t._v("-")]),n("span",{attrs:{class:"token operator"}},[t._v(">")]),n("span",{attrs:{class:"token function"}},[t._v("get")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'user/notifications/stats'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'NotificationsController@stats'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),n("span",{attrs:{class:"token operator"}},[t._v("-")]),n("span",{attrs:{class:"token operator"}},[t._v(">")]),n("span",{attrs:{class:"token function"}},[t._v("name")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'api.user.notifications.stats'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{attrs:{class:"token comment"}},[t._v("// 标记消息通知为已读")]),t._v("\n"),n("span",{attrs:{class:"token variable"}},[t._v("$api")]),n("span",{attrs:{class:"token operator"}},[t._v("-")]),n("span",{attrs:{class:"token operator"}},[t._v(">")]),n("span",{attrs:{class:"token function"}},[t._v("patch")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'user/read/notifications'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'NotificationsController@read'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),n("span",{attrs:{class:"token operator"}},[t._v("-")]),n("span",{attrs:{class:"token operator"}},[t._v(">")]),n("span",{attrs:{class:"token function"}},[t._v("name")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'api.user.notifications.read'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n")])]),n("p",[t._v("这里我们参考了 Github Api "),n("a",{attrs:{href:"https://developer.github.com/v3/activity/starring/#star-a-repository",target:"_blank",rel:"noopener noreferrer"}},[t._v("Starring")]),t._v(" 的部分，"),n("code",[t._v("PUT /user/starred/:owner/:repo")]),t._v(" 为 star 某个仓库，同样标记单个通知为已读我们可以设计为 "),n("code",[t._v("PUT /user/read/notifications/{notification_id}")]),t._v("，但是这里我们会批量将所有未读消息标记为已读，考虑到幂等性原则，使用 PATCH 更为合适，最终设计为 "),n("code",[t._v("PATCH /user/read/notifications")]),t._v("。")]),n("h2",{attrs:{id:"_2-修改-controller"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-修改-controller","aria-hidden":"true"}},[t._v("#")]),t._v(" 2. 修改 Controller")]),n("p",[n("em",[t._v("app/Http/Controllers/Api/NotificationsController.php")])]),n("pre",{pre:!0,attrs:{class:"language-php"}},[n("code",[n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("read")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),n("span",{attrs:{class:"token variable"}},[t._v("$this")]),n("span",{attrs:{class:"token operator"}},[t._v("-")]),n("span",{attrs:{class:"token operator"}},[t._v(">")]),n("span",{attrs:{class:"token function"}},[t._v("user")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token operator"}},[t._v("-")]),n("span",{attrs:{class:"token operator"}},[t._v(">")]),n("span",{attrs:{class:"token function"}},[t._v("markAsRead")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),n("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),n("span",{attrs:{class:"token variable"}},[t._v("$this")]),n("span",{attrs:{class:"token operator"}},[t._v("-")]),n("span",{attrs:{class:"token operator"}},[t._v(">")]),n("span",{attrs:{class:"token property"}},[t._v("response")]),n("span",{attrs:{class:"token operator"}},[t._v("-")]),n("span",{attrs:{class:"token operator"}},[t._v(">")]),n("span",{attrs:{class:"token function"}},[t._v("noContent")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n")])]),n("p",[n("code",[t._v("markAsRead")]),t._v(" 是上一本教程中已经处理好的方法，会将用户 "),n("code",[t._v("notification_count")]),t._v(" 设置为 0，将所有未读消息设置为已读。代码如下：")]),n("p",[n("em",[t._v("app\\Models\\User.php")])]),n("pre",{pre:!0,attrs:{class:"language-php"}},[n("code",[n("span",{attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("markAsRead")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),n("span",{attrs:{class:"token variable"}},[t._v("$this")]),n("span",{attrs:{class:"token operator"}},[t._v("-")]),n("span",{attrs:{class:"token operator"}},[t._v(">")]),n("span",{attrs:{class:"token property"}},[t._v("notification_count")]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{attrs:{class:"token number"}},[t._v("0")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{attrs:{class:"token variable"}},[t._v("$this")]),n("span",{attrs:{class:"token operator"}},[t._v("-")]),n("span",{attrs:{class:"token operator"}},[t._v(">")]),n("span",{attrs:{class:"token function"}},[t._v("save")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{attrs:{class:"token variable"}},[t._v("$this")]),n("span",{attrs:{class:"token operator"}},[t._v("-")]),n("span",{attrs:{class:"token operator"}},[t._v(">")]),n("span",{attrs:{class:"token property"}},[t._v("unreadNotifications")]),n("span",{attrs:{class:"token operator"}},[t._v("-")]),n("span",{attrs:{class:"token operator"}},[t._v(">")]),n("span",{attrs:{class:"token function"}},[t._v("markAsRead")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),n("h2",{attrs:{id:"_3-使用-postman-调试"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-使用-postman-调试","aria-hidden":"true"}},[t._v("#")]),t._v(" 3. 使用 PostMan 调试")]),n("p",[n("img",{attrs:{src:a(646),alt:"file"}})]),n("p",[t._v("再次访问"),n("code",[t._v("消息通知统计接口")])]),n("p",[n("img",{attrs:{src:a(645),alt:"file"}})]),n("p",[t._v("未读消息已经清零。")]),n("h2",{attrs:{id:"代码版本控制"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#代码版本控制","aria-hidden":"true"}},[t._v("#")]),t._v(" 代码版本控制")]),n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("$ "),n("span",{attrs:{class:"token function"}},[t._v("git")]),t._v(" add -A\n$ "),n("span",{attrs:{class:"token function"}},[t._v("git")]),t._v(" commit -m "),n("span",{attrs:{class:"token string"}},[t._v("'notifications read'")]),t._v("\n")])])])}],o=a(0),r=Object(o.a)({},function(){this.$createElement;this._self._c;return this._m(0)},n,!1,null,null,null);s.default=r.exports},645:function(t,s,a){t.exports=a.p+"assets/img/6.6_2.426da191.png"},646:function(t,s,a){t.exports=a.p+"assets/img/6.6_1.80829fa3.png"}}]);