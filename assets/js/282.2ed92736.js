(window.webpackJsonp=window.webpackJsonp||[]).push([[282],{1360:function(t,s,a){"use strict";a.r(s);var n=[function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("div",{staticClass:"content"},[n("h1",{attrs:{id:"_10-2-passport-安装"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_10-2-passport-安装","aria-hidden":"true"}},[t._v("#")]),t._v(" 10.2 Passport 安装")]),n("h3",{attrs:{id:"_1-创建新分支"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-创建新分支","aria-hidden":"true"}},[t._v("#")]),t._v(" 1. 创建新分支")]),n("p",[t._v("由于是将原有的认证方式 JWT，替换为 OAuth2，所以我们新建一个分支来进行代码开发")]),n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("$ "),n("span",{attrs:{class:"token function"}},[t._v("git")]),t._v(" checkout -b passport\n")])]),n("h3",{attrs:{id:"_2-composer-安装"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-composer-安装","aria-hidden":"true"}},[t._v("#")]),t._v(" 2. Composer 安装")]),n("p",[t._v("使用 Composer 安装 Passport ：")]),n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("composer require laravel/passport:~4.0\n")])]),n("p",[t._v("注意 Laravel 5.6 已经发布，最新的 "),n("code",[t._v("laravel/passport")]),t._v(" 版本为 "),n("code",[t._v("5.0")]),t._v(" 适配 Laravel 5.6，所以我们需要使用 Laravel 5.5 的适配版本 "),n("code",[t._v("4.0")]),t._v("。")]),n("p",[n("img",{attrs:{src:a(772),alt:"file"}})]),n("h3",{attrs:{id:"_3-生成数据表"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-生成数据表","aria-hidden":"true"}},[t._v("#")]),t._v(" 3. 生成数据表")]),n("p",[t._v("Passport 扩展包里已经自动注册了迁移文件加载，执行 "),n("code",[t._v("migrate")]),t._v("，会自动运行扩展包里的迁移文件，由此来创建存储客户端和令牌的数据表：")]),n("p",[n("img",{attrs:{src:a(771),alt:"file"}})]),n("h3",{attrs:{id:"_4-创建加密秘钥"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-创建加密秘钥","aria-hidden":"true"}},[t._v("#")]),t._v(" 4. 创建加密秘钥")]),n("p",[t._v("接下来，运行 "),n("code",[t._v("php artisan passport:keys")]),t._v(" 命令来创建生成安全访问令牌时所需的加密密钥：")]),n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("$ php artisan passport:keys\n")])]),n("p",[n("img",{attrs:{src:a(770),alt:"file"}})]),n("p",[t._v("执行成功后，会在 "),n("code",[t._v("storage")]),t._v(" 目录中看到两个以 "),n("code",[t._v("oauth")]),t._v(" 开头的秘钥文件：")]),n("p",[n("img",{attrs:{src:a(769),alt:"file"}})]),n("h3",{attrs:{id:"_5-创建客户端"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-创建客户端","aria-hidden":"true"}},[t._v("#")]),t._v(" 5. 创建客户端")]),n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("$ php artisan passport:client --password --name"),n("span",{attrs:{class:"token operator"}},[t._v("=")]),n("span",{attrs:{class:"token string"}},[t._v("'larabbs-ios'")]),t._v("\n")])]),n("p",[n("code",[t._v("passport:client")]),t._v(" 命令可以创建一个客户端，由于我们使用的是密码模式，所以需要增加 "),n("code",[t._v("--password")]),t._v(" 参数。同时还可以增加 "),n("code",[t._v("--name")]),t._v(" 参数为客户端起个名字，我们这里起名为 "),n("code",[t._v("larabbs-ios")]),t._v("：")]),n("p",[n("img",{attrs:{src:a(768),alt:"file"}})]),n("p",[t._v("命令行中已经输出了创建的 "),n("code",[t._v("client_id")]),t._v(" 和 "),n("code",[t._v("client_secret")]),t._v("，我们找个地方复制保存起来。")]),n("h2",{attrs:{id:"passport-调试"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#passport-调试","aria-hidden":"true"}},[t._v("#")]),t._v(" Passport 调试")]),n("h3",{attrs:{id:"_1-注册路由"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-注册路由","aria-hidden":"true"}},[t._v("#")]),t._v(" 1. 注册路由")]),n("p",[t._v("安装好了 Passport 我们来调试一下，"),n("code",[t._v("Passport::routes")]),t._v(" 是 Passport 为我们提供了基础的路由，我们先注册一下路由。")]),n("p",[n("em",[t._v("app/Providers/AuthServiceProvider.php")])]),n("pre",{pre:!0,attrs:{class:"language-php"}},[n("code",[n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token keyword"}},[t._v("use")]),t._v(" "),n("span",{attrs:{class:"token package"}},[t._v("Carbon"),n("span",{attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("Carbon")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{attrs:{class:"token keyword"}},[t._v("use")]),t._v(" "),n("span",{attrs:{class:"token package"}},[t._v("Laravel"),n("span",{attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("Passport"),n("span",{attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("Passport")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("boot")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),n("span",{attrs:{class:"token variable"}},[t._v("$this")]),n("span",{attrs:{class:"token operator"}},[t._v("-")]),n("span",{attrs:{class:"token operator"}},[t._v(">")]),n("span",{attrs:{class:"token function"}},[t._v("registerPolicies")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),n("span",{attrs:{class:"token comment"}},[t._v("// Passport 的路由")]),t._v("\n  Passport"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{attrs:{class:"token function"}},[t._v("routes")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{attrs:{class:"token comment"}},[t._v("// access_token 过期时间")]),t._v("\n  Passport"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{attrs:{class:"token function"}},[t._v("tokensExpireIn")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Carbon"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{attrs:{class:"token function"}},[t._v("now")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token operator"}},[t._v("-")]),n("span",{attrs:{class:"token operator"}},[t._v(">")]),n("span",{attrs:{class:"token function"}},[t._v("addDays")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token number"}},[t._v("15")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{attrs:{class:"token comment"}},[t._v("// refreshTokens 过期时间")]),t._v("\n  Passport"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{attrs:{class:"token function"}},[t._v("refreshTokensExpireIn")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Carbon"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{attrs:{class:"token function"}},[t._v("now")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token operator"}},[t._v("-")]),n("span",{attrs:{class:"token operator"}},[t._v(">")]),n("span",{attrs:{class:"token function"}},[t._v("addDays")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token number"}},[t._v("30")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  \\"),n("span",{attrs:{class:"token package"}},[t._v("Horizon")]),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{attrs:{class:"token function"}},[t._v("auth")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token variable"}},[t._v("$request")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{attrs:{class:"token comment"}},[t._v("// 是否是站长")]),t._v("\n    "),n("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" \\"),n("span",{attrs:{class:"token package"}},[t._v("Auth")]),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{attrs:{class:"token function"}},[t._v("user")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token operator"}},[t._v("-")]),n("span",{attrs:{class:"token operator"}},[t._v(">")]),n("span",{attrs:{class:"token function"}},[t._v("hasRole")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'Founder'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n")])]),n("p",[t._v("我们注册了路由，同时通过 Passport 的 "),n("code",[t._v("tokensExpireIn")]),t._v(" 和 "),n("code",[t._v("refreshTokensExpireIn")]),t._v(" 定义了访问令牌的过期时间，否则访问令牌是永久有效的。这里我们定义 "),n("code",[t._v("access_token")]),t._v(" 15 天内有效，"),n("code",[t._v("refresh_token")]),t._v(" 30天内有效。")]),n("h3",{attrs:{id:"_2-获取访问令牌"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-获取访问令牌","aria-hidden":"true"}},[t._v("#")]),t._v(" 2. 获取访问令牌")]),n("p",[t._v("密码模式我们通过 "),n("a",{attrs:{href:"http://larabbs.test/oauth/token",target:"_blank",rel:"noopener noreferrer"}},[t._v("larabbs.test/oauth/token")]),t._v(" 这个路由获取访问令牌。提交的参数如下")]),n("ul",[n("li",[t._v("grant_type —— 密码模式固定为 "),n("code",[t._v("password")]),t._v("；")]),n("li",[t._v("client_id —— 通过 "),n("code",[t._v("passport:client")]),t._v(" 创建的客户端 "),n("code",[t._v("id")]),t._v("；")]),n("li",[t._v("client_secret ——  通过 "),n("code",[t._v("passport:client")]),t._v(" 创建的客户端 "),n("code",[t._v("secret")]),t._v("；")]),n("li",[t._v("username —— 登录的用户名，数据库中任意用户邮箱；")]),n("li",[t._v("password —— 用户密码；")]),n("li",[t._v("scope —— 作用域，可填写 "),n("code",[t._v("*")]),t._v(" 或者为空；")])]),n("p",[n("img",{attrs:{src:a(767),alt:"file"}})]),n("p",[t._v("提交正确的 "),n("code",[t._v("client")]),t._v(" 信息以及任意已存在用户的用户名和密码，可以正确的获取到访问令牌。")]),n("ul",[n("li",[t._v("token_type —— 令牌类型；")]),n("li",[t._v("expires_in—— 多长时间后过期；")]),n("li",[t._v("access_token —— 访问令牌；")]),n("li",[t._v("refresh_token —— 刷新令牌；")])]),n("h3",{attrs:{id:"_3-刷新访问令牌"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-刷新访问令牌","aria-hidden":"true"}},[t._v("#")]),t._v(" 3. 刷新访问令牌")]),n("p",[n("code",[t._v("刷新访问令牌")]),t._v(" 接口与 "),n("code",[t._v("获取访问令牌")]),t._v(" 接口一样，只是参数不同。")]),n("ul",[n("li",[t._v("grant_type —— 刷新令牌固定为 "),n("code",[t._v("refresh_token")]),t._v("；")]),n("li",[t._v("client_id —— 通过 "),n("code",[t._v("passport:client")]),t._v(" 创建的客户端 "),n("code",[t._v("id")]),t._v("；")]),n("li",[t._v("client_secret ——  通过 "),n("code",[t._v("passport:client")]),t._v(" 创建的客户端 "),n("code",[t._v("secret")]),t._v("；")]),n("li",[t._v("refresh_token —— 刷新令牌；")]),n("li",[t._v("scope —— 作用域，可填写 "),n("code",[t._v("*")]),t._v(" 或者为空；")])]),n("p",[n("img",{attrs:{src:a(766),alt:"file"}})]),n("p",[t._v("刷新令牌不用提交用户的用户名和密码，而是直接使用 "),n("code",[t._v("refresh_token")]),t._v(" 换取新的访问令牌，注意修改 "),n("code",[t._v("grant_type")]),t._v(" 为 "),n("code",[t._v("refresh_token")]),t._v("。")]),n("h2",{attrs:{id:"关于-refresh-token"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#关于-refresh-token","aria-hidden":"true"}},[t._v("#")]),t._v(" 关于  Refresh Token")]),n("p",[n("img",{attrs:{src:a(765),alt:"file"}})]),n("p",[t._v("为什么要刷新 Access Token 呢？")]),n("ul",[n("li",[t._v("一是因为 Access Token 是有过期时间的，到了过期时间这个 Access Token 就会失效，需要刷新；")]),n("li",[t._v("二是因为一个 Access Token 会关联一定的用户权限，如果用户授权更改了，这个 Access Token 需要被刷新以关联新的权限。")])]),n("p",[t._v("为什么要专门用一个 Token 去更新 Access Token 呢？如果没有 Refresh Token，也可以刷新 Access Token，但每次刷新都要用户输入登录用户名与密码，多麻烦。有了 refresh Token，可以减少这个麻烦，客户端直接用 Refresh Token 去更新 Access Token，无需用户进行额外的操作。")]),n("p",[t._v("Refresh Token 也有过期时间但是时间相对较长。 Refresh Token 对存储的要求通常会非常严格，以确保它不会被泄漏；它们也可以被授权服务器列入黑名单。")]),n("h2",{attrs:{id:"代码版本控制"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#代码版本控制","aria-hidden":"true"}},[t._v("#")]),t._v(" 代码版本控制")]),n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("$ "),n("span",{attrs:{class:"token function"}},[t._v("git")]),t._v(" add -A\n$ "),n("span",{attrs:{class:"token function"}},[t._v("git")]),t._v(" commit -m "),n("span",{attrs:{class:"token string"}},[t._v("'add passport'")]),t._v("\n")])])])}],e=a(0),o=Object(e.a)({},function(){this.$createElement;this._self._c;return this._m(0)},n,!1,null,null,null);s.default=o.exports},765:function(t,s,a){t.exports=a.p+"assets/img/10.2_8.9e27f888.png"},766:function(t,s,a){t.exports=a.p+"assets/img/10.2_7.717e1276.png"},767:function(t,s,a){t.exports=a.p+"assets/img/10.2_6.0c8ebbcb.png"},768:function(t,s,a){t.exports=a.p+"assets/img/10.2_5.140f3a05.png"},769:function(t,s,a){t.exports=a.p+"assets/img/10.2_4.30f8d5a0.png"},770:function(t,s,a){t.exports=a.p+"assets/img/10.2_3.4a3e71ca.png"},771:function(t,s,a){t.exports=a.p+"assets/img/10.2_2.3ec8fff8.png"},772:function(t,s,a){t.exports=a.p+"assets/img/10.2_1.11c38407.png"}}]);