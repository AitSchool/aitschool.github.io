(window.webpackJsonp=window.webpackJsonp||[]).push([[241],{1298:function(t,s,a){"use strict";a.r(s);var n=[function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("div",{staticClass:"content"},[n("h1",{attrs:{id:"_8-3-本地化"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_8-3-本地化","aria-hidden":"true"}},[t._v("#")]),t._v(" 8.3 本地化")]),n("p",[t._v("这一节我们来实现接口的本地化。本地化主要的是客户端的工作，切换语言后，客户端显示不同的界面，例如下面就是微信 "),n("strong",[t._v("中文")]),t._v(" 和 "),n("strong",[t._v("英文")]),t._v(" 语言下的界面。")]),n("p",[n("img",{attrs:{src:a(629),alt:"file"}})]),n("p",[t._v("除了界面显示之外，还有一些报错信息需要做本地化，举个例子，用户登录时，密码错误：")]),n("ul",[n("li",[t._v("英文客户端，提示 "),n("code",[t._v("invalid username or password")])]),n("li",[t._v("中文客户端，提示 "),n("code",[t._v("用户名和密码错误")])])]),n("p",[t._v("报错信息本地化的处理方式，一般有两种：")]),n("ul",[n("li",[t._v("客户端通过服务器端返回的状态码和错误码，自行翻译为错误信息；")]),n("li",[t._v("服务器端返回状态码时，返回已经格式化了的错误消息。")])]),n("p",[t._v("接下来我们会一一讲解。")]),n("h2",{attrs:{id:"_1-本地化完全交给客户端"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-本地化完全交给客户端","aria-hidden":"true"}},[t._v("#")]),t._v(" 1. 本地化完全交给客户端")]),n("p",[t._v("因为我们是 RESTFul 风格的接口，返回了标准的状态码，大部分情况下，客户端可以根据状态码，以及语言设置提示给用户不同语言的报错信息。例如上面的例子，客户端调用 "),n("code",[t._v("登录")]),t._v(" 接口时，报错信息中的 message 统一为中文，客户端根据状态码等标识进行本地化提示。")]),n("pre",{pre:!0,attrs:{class:"language-php"}},[n("code",[n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{attrs:{class:"token double-quoted-string string"}},[t._v('"message"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token double-quoted-string string"}},[t._v('"用户名和密码错误"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),n("span",{attrs:{class:"token double-quoted-string string"}},[t._v('"status_code"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token number"}},[t._v("401")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),n("p",[t._v("但是某些情况下，只有状态码是不够的，比如下面这个场景 "),n("code",[t._v("发布话题")]),t._v("，我们增加了以下限制：")]),n("table",[n("thead",[n("tr",[n("th",[t._v("错误原因")]),n("th",[t._v("状态码")]),n("th",[t._v("错误描述")])])]),n("tbody",[n("tr",[n("td",[t._v("被加入黑名单的用户不能发帖")]),n("td",[t._v("403")]),n("td",[t._v("您已被加入黑名单")])]),n("tr",[n("td",[t._v("会员用户才能发帖")]),n("td",[t._v("403")]),n("td",[t._v("您的还不是会员")])]),n("tr",[n("td",[t._v("实名认证的用户才能发帖")]),n("td",[t._v("403")]),n("td",[t._v("您还没有通过认证")])])])]),n("p",[t._v("状态码都是 403 但是报错信息却不同，这时就需要定义不同的错误码，以便让客户端进行判断：")]),n("table",[n("thead",[n("tr",[n("th",[t._v("错误原因")]),n("th",[t._v("状态码")]),n("th",[t._v("错误描述")]),n("th",[t._v("自定义错误码")])])]),n("tbody",[n("tr",[n("td",[t._v("被加入黑名单的用户不能发帖")]),n("td",[t._v("403")]),n("td",[t._v("您已被加入黑名单")]),n("td",[t._v("1001")])]),n("tr",[n("td",[t._v("会员用户才能发帖")]),n("td",[t._v("403")]),n("td",[t._v("您的还不是会员")]),n("td",[t._v("1002")])]),n("tr",[n("td",[t._v("实名认证的用户才能发帖")]),n("td",[t._v("403")]),n("td",[t._v("您还没有通过认证")]),n("td",[t._v("1003")])])])]),n("p",[t._v("接口响应类似下面这样：")]),n("pre",{pre:!0,attrs:{class:"language-php"}},[n("code",[n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{attrs:{class:"token double-quoted-string string"}},[t._v('"message"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token double-quoted-string string"}},[t._v('"您还没有通过认证"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),n("span",{attrs:{class:"token double-quoted-string string"}},[t._v('"status_code"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token number"}},[t._v("403")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),n("span",{attrs:{class:"token double-quoted-string string"}},[t._v('"code"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token number"}},[t._v("1003")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),n("h3",{attrs:{id:"错误响应中增加-code-错误码字段"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#错误响应中增加-code-错误码字段","aria-hidden":"true"}},[t._v("#")]),t._v(" 错误响应中增加 code 错误码字段")]),n("p",[t._v("我们需要提前定义好『错误码』，并且在响应中增加 code 字段，这样客户端才能错误码，提示出正确的报错信息。DingoApi 会自动将异常中的异常码 （code）添加到响应中，所以我们只需要抛出异常的时候增加自定义的异常码即可，例如：")]),n("pre",{pre:!0,attrs:{class:"language-php"}},[n("code",[n("span",{attrs:{class:"token keyword"}},[t._v("throw")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),n("span",{attrs:{class:"token class-name"}},[n("span",{attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("Symfony"),n("span",{attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("Component"),n("span",{attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("HttpKernel"),n("span",{attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("Exception"),n("span",{attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("HttpException")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n    "),n("span",{attrs:{class:"token number"}},[t._v("401")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" \n    "),n("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'您还没有通过认证'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" \n    "),n("span",{attrs:{class:"token keyword"}},[t._v("null")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" \n    "),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" \n    "),n("span",{attrs:{class:"token number"}},[t._v("1003")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),n("h3",{attrs:{id:"进行封装"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#进行封装","aria-hidden":"true"}},[t._v("#")]),t._v(" 进行封装")]),n("p",[t._v("我们就会得到上面的响应结果。当然我们应该对上述代码进行封装：")]),n("p",[n("em",[t._v("app/Http/Controllers/Api/Controller.php")])]),n("pre",{pre:!0,attrs:{class:"language-php"}},[n("code",[n("span",{attrs:{class:"token php language-php"}},[n("span",{attrs:{class:"token delimiter important"}},[t._v("<?php")]),t._v("\n\n"),n("span",{attrs:{class:"token keyword"}},[t._v("namespace")]),t._v(" "),n("span",{attrs:{class:"token package"}},[t._v("App"),n("span",{attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("Http"),n("span",{attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("Controllers"),n("span",{attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("Api")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),n("span",{attrs:{class:"token keyword"}},[t._v("use")]),t._v(" "),n("span",{attrs:{class:"token package"}},[t._v("Illuminate"),n("span",{attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("Http"),n("span",{attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("Request")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{attrs:{class:"token keyword"}},[t._v("use")]),t._v(" "),n("span",{attrs:{class:"token package"}},[t._v("Dingo"),n("span",{attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("Api"),n("span",{attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("Routing"),n("span",{attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("Helpers")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{attrs:{class:"token keyword"}},[t._v("use")]),t._v(" "),n("span",{attrs:{class:"token package"}},[t._v("App"),n("span",{attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("Http"),n("span",{attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("Controllers"),n("span",{attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("Controller")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("as")]),t._v(" BaseController"),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{attrs:{class:"token keyword"}},[t._v("use")]),t._v(" "),n("span",{attrs:{class:"token package"}},[t._v("Symfony"),n("span",{attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("Component"),n("span",{attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("HttpKernel"),n("span",{attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("Exception"),n("span",{attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("HttpException")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),n("span",{attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),n("span",{attrs:{class:"token class-name"}},[t._v("Controller")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("extends")]),t._v(" "),n("span",{attrs:{class:"token class-name"}},[t._v("BaseController")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{attrs:{class:"token keyword"}},[t._v("use")]),t._v(" "),n("span",{attrs:{class:"token package"}},[t._v("Helpers")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),n("span",{attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("errorResponse")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token variable"}},[t._v("$statusCode")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token variable"}},[t._v("$message")]),n("span",{attrs:{class:"token operator"}},[t._v("=")]),n("span",{attrs:{class:"token keyword"}},[t._v("null")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token variable"}},[t._v("$code")]),n("span",{attrs:{class:"token operator"}},[t._v("=")]),n("span",{attrs:{class:"token number"}},[t._v("0")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),n("span",{attrs:{class:"token keyword"}},[t._v("throw")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),n("span",{attrs:{class:"token class-name"}},[t._v("HttpException")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token variable"}},[t._v("$statusCode")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token variable"}},[t._v("$message")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("null")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token variable"}},[t._v("$code")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("p",[t._v("我们在 "),n("code",[t._v("Api/Controller")]),t._v(" 中加了 "),n("code",[t._v("errorResponse")]),t._v(" 方法，所以我们在任意 API 控制器中直接使用 "),n("code",[t._v("$this->errorResponse")]),t._v(" 即可。")]),n("h3",{attrs:{id:"添加测试代码"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#添加测试代码","aria-hidden":"true"}},[t._v("#")]),t._v(" 添加测试代码")]),n("p",[t._v("比如我们在 "),n("code",[t._v("发布话题")]),t._v(" 接口的代码中增加下面的测试代码：")]),n("p",[n("em",[t._v("app/Http/Controllers/Api/TopicsController.php")])]),n("pre",{pre:!0,attrs:{class:"language-php"}},[n("code",[n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("store")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("TopicRequest "),n("span",{attrs:{class:"token variable"}},[t._v("$request")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" Topic "),n("span",{attrs:{class:"token variable"}},[t._v("$topic")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),n("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),n("span",{attrs:{class:"token variable"}},[t._v("$this")]),n("span",{attrs:{class:"token operator"}},[t._v("-")]),n("span",{attrs:{class:"token operator"}},[t._v(">")]),n("span",{attrs:{class:"token function"}},[t._v("errorResponse")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token number"}},[t._v("403")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'您还没有通过认证'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token number"}},[t._v("1003")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n")])]),n("p",[t._v("由于是我们假设的业务，所以直接抛出异常，观察响应。")]),n("h3",{attrs:{id:"使用-postman-调试"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#使用-postman-调试","aria-hidden":"true"}},[t._v("#")]),t._v(" 使用 PostMan 调试")]),n("p",[n("img",{attrs:{src:a(628),alt:"file"}})]),n("p",[t._v("可以看到响应中增加了 code 字段。记得还原测试代码：")]),n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("$ "),n("span",{attrs:{class:"token function"}},[t._v("git")]),t._v(" checkout app/Http/Controllers/Api/TopicsController.php\n")])]),n("h2",{attrs:{id:"_2-接口根据客户端语言切换错误信息"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-接口根据客户端语言切换错误信息","aria-hidden":"true"}},[t._v("#")]),t._v(" 2. 接口根据客户端语言切换错误信息")]),n("p",[t._v("如果接口根据客户端语言设置，返回对应语言的报错信息，客户端就可以直接将服务器报错提示给用户。由于每个接口都是无状态的，客户端需要在每次请求接口的时候增加参数，告诉接口支持的语言。我们可以利用 HTTP 的 "),n("code",[t._v("Accept-Language")]),t._v(" 头信息。")]),n("ul",[n("li",[t._v("Accept-Language zh-CN —— 简体中文")]),n("li",[t._v("Accept-Language en  —— 英文")])]),n("h3",{attrs:{id:"增加-middleware"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#增加-middleware","aria-hidden":"true"}},[t._v("#")]),t._v(" 增加 middleware")]),n("p",[t._v("通过以下命令创建一个中间件。")]),n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("$ php artisan make:middleware ChangeLocale\n")])]),n("p",[t._v("打开文件，填入如下代码：")]),n("p",[n("em",[t._v("app/Http/Middleware/ChangeLocale.php")])]),n("pre",{pre:!0,attrs:{class:"language-php"}},[n("code",[n("span",{attrs:{class:"token php language-php"}},[n("span",{attrs:{class:"token delimiter important"}},[t._v("<?php")]),t._v("\n\n"),n("span",{attrs:{class:"token keyword"}},[t._v("namespace")]),t._v(" "),n("span",{attrs:{class:"token package"}},[t._v("App"),n("span",{attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("Http"),n("span",{attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("Middleware")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),n("span",{attrs:{class:"token keyword"}},[t._v("use")]),t._v(" "),n("span",{attrs:{class:"token package"}},[t._v("Closure")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),n("span",{attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),n("span",{attrs:{class:"token class-name"}},[t._v("ChangeLocale")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{attrs:{class:"token comment"}},[t._v("/**\n     * Handle an incoming request.\n     *\n     * @param  \\Illuminate\\Http\\Request  $request\n     * @param  \\Closure  $next\n     * @return mixed\n     */")]),t._v("\n    "),n("span",{attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("handle")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token variable"}},[t._v("$request")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" Closure "),n("span",{attrs:{class:"token variable"}},[t._v("$next")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),n("span",{attrs:{class:"token variable"}},[t._v("$language")]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{attrs:{class:"token variable"}},[t._v("$request")]),n("span",{attrs:{class:"token operator"}},[t._v("-")]),n("span",{attrs:{class:"token operator"}},[t._v(">")]),n("span",{attrs:{class:"token function"}},[t._v("header")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'accept-language'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),n("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token variable"}},[t._v("$language")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            \\"),n("span",{attrs:{class:"token package"}},[t._v("App")]),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{attrs:{class:"token function"}},[t._v("setLocale")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token variable"}},[t._v("$language")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n        "),n("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),n("span",{attrs:{class:"token variable"}},[t._v("$next")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token variable"}},[t._v("$request")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("p",[t._v("逻辑很简单，获取请求头中的 "),n("code",[t._v("accept-language")]),t._v("，然后设置语言。")]),n("h3",{attrs:{id:"注册中间件"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#注册中间件","aria-hidden":"true"}},[t._v("#")]),t._v(" 注册中间件")]),n("p",[n("em",[t._v("app/Http/Kernel.php")])]),n("pre",{pre:!0,attrs:{class:"language-php"}},[n("code",[n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token comment"}},[t._v("// 访问节流，类似于 『1 分钟只能请求 10 次』的需求，一般在 API 中使用")]),t._v("\n"),n("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'throttle'")]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),n("span",{attrs:{class:"token operator"}},[t._v(">")]),t._v(" \\"),n("span",{attrs:{class:"token package"}},[t._v("Illuminate"),n("span",{attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("Routing"),n("span",{attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("Middleware"),n("span",{attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("ThrottleRequests")]),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{attrs:{class:"token keyword"}},[t._v("class")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    \n"),n("span",{attrs:{class:"token comment"}},[t._v("// 接口语言设置")]),t._v("\n"),n("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'change-locale'")]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),n("span",{attrs:{class:"token operator"}},[t._v(">")]),t._v(" \\"),n("span",{attrs:{class:"token package"}},[t._v("App"),n("span",{attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("Http"),n("span",{attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("Middleware"),n("span",{attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("ChangeLocale")]),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{attrs:{class:"token keyword"}},[t._v("class")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n")])]),n("p",[n("em",[t._v("routes/api.php")])]),n("pre",{pre:!0,attrs:{class:"language-php"}},[n("code",[n("span",{attrs:{class:"token variable"}},[t._v("$api")]),n("span",{attrs:{class:"token operator"}},[t._v("-")]),n("span",{attrs:{class:"token operator"}},[t._v(">")]),n("span",{attrs:{class:"token function"}},[t._v("version")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'v1'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n    "),n("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'namespace'")]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),n("span",{attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),n("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'App\\Http\\Controllers\\Api'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),n("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'middleware'")]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),n("span",{attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'serializer:array'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'bindings'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'change-locale'")]),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token variable"}},[t._v("$api")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n")])]),n("p",[t._v("我们注册了 "),n("code",[t._v("change-locale")]),t._v(" 这个中间件，并且在 v1版本的接口中增加该中间件。")]),n("h3",{attrs:{id:"postman-调试"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#postman-调试","aria-hidden":"true"}},[t._v("#")]),t._v(" PostMan 调试")]),n("p",[t._v("接下来我们以 "),n("code",[t._v("登录")]),t._v(" 接口为例。")]),n("p",[t._v("由于我们已经在 config/app.php 中设置了默认的语言为"),n("code",[t._v("'locale' => 'zh-CN',")]),t._v(" 简体中文，所以我们直接访问登录接口，密码只填写3位。")]),n("p",[n("img",{attrs:{src:a(627),alt:"file"}})]),n("p",[t._v("可以看到中文的报错信息：")]),n("p",[t._v("增加 "),n("code",[t._v("accept-language")]),t._v(" 头，值为 "),n("code",[t._v("en")]),t._v(" 切换为英文。\n"),n("img",{attrs:{src:a(626),alt:"file"}})]),n("p",[t._v("可以切换语言，并且得到了正确的报错信息，看一下登录的代码：")]),n("p",[n("em",[t._v("app/Http/Controllers/Api/AuthorizationsController.php")])]),n("pre",{pre:!0,attrs:{class:"language-php"}},[n("code",[n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token operator"}},[t._v("!")]),n("span",{attrs:{class:"token variable"}},[t._v("$token")]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" \\"),n("span",{attrs:{class:"token package"}},[t._v("Auth")]),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{attrs:{class:"token function"}},[t._v("guard")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'api'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token operator"}},[t._v("-")]),n("span",{attrs:{class:"token operator"}},[t._v(">")]),n("span",{attrs:{class:"token function"}},[t._v("attempt")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token variable"}},[t._v("$credentials")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),n("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),n("span",{attrs:{class:"token variable"}},[t._v("$this")]),n("span",{attrs:{class:"token operator"}},[t._v("-")]),n("span",{attrs:{class:"token operator"}},[t._v(">")]),n("span",{attrs:{class:"token property"}},[t._v("response")]),n("span",{attrs:{class:"token operator"}},[t._v("-")]),n("span",{attrs:{class:"token operator"}},[t._v(">")]),n("span",{attrs:{class:"token function"}},[t._v("errorUnauthorized")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'用户名或密码错误'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n")])]),n("p",[t._v("发现用户名密码错误的时候，报错并没有进行本地化处理，修改代码如下：")]),n("pre",{pre:!0,attrs:{class:"language-php"}},[n("code",[n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token operator"}},[t._v("!")]),n("span",{attrs:{class:"token variable"}},[t._v("$token")]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" \\"),n("span",{attrs:{class:"token package"}},[t._v("Auth")]),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{attrs:{class:"token function"}},[t._v("guard")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'api'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token operator"}},[t._v("-")]),n("span",{attrs:{class:"token operator"}},[t._v(">")]),n("span",{attrs:{class:"token function"}},[t._v("attempt")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token variable"}},[t._v("$credentials")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),n("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),n("span",{attrs:{class:"token variable"}},[t._v("$this")]),n("span",{attrs:{class:"token operator"}},[t._v("-")]),n("span",{attrs:{class:"token operator"}},[t._v(">")]),n("span",{attrs:{class:"token property"}},[t._v("response")]),n("span",{attrs:{class:"token operator"}},[t._v("-")]),n("span",{attrs:{class:"token operator"}},[t._v(">")]),n("span",{attrs:{class:"token function"}},[t._v("errorUnauthorized")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token function"}},[t._v("trans")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'auth.failed'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n")])]),n("p",[t._v("输入错误的密码，访问登录接口来测试。")]),n("p",[t._v("使用默认的中文：")]),n("p",[n("img",{attrs:{src:a(625),alt:"file"}})]),n("p",[t._v("设置为英文：")]),n("p",[n("img",{attrs:{src:a(624),alt:"file"}})]),n("h2",{attrs:{id:"方案总结"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#方案总结","aria-hidden":"true"}},[t._v("#")]),t._v(" 方案总结")]),n("p",[t._v("第一种方案比较专业，大部分的第三方 API 平台接口提供方都会提供状态码，如 "),n("a",{attrs:{href:"http://open.weibo.com/wiki/Error_code",target:"_blank",rel:"noopener noreferrer"}},[t._v("新浪微博")]),t._v(" 错误码，但是你需要一个个地将错误码写出。在某些开发需求中，错误码可能不仅影响本地化，有时客户端需要服务器返回的特定状态码做不同的业务处理，比如跳转到不同的页面。")]),n("p",[t._v("第二种方案比较便捷，客户端可以直接将服务器的报错消息显示给用户，从快速实现的角度来看，省去了错误码的定义，并且后期可通过服务器代码来控制错误消息内容，也带来一定的灵活性。")]),n("p",[t._v("从接口的可扩展性、适用性和专业性上考虑，最合理的也是最推荐的做法是将两种方案合并 —— API 既提供错误码，又提供错误消息。")]),n("p",[t._v("另外，错误消息 "),n("strong",[t._v("默认")]),t._v(" 返回英文，也会是比较合理的最佳实践，当然最终视 API 业务逻辑而定。")]),n("h2",{attrs:{id:"代码版本控制"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#代码版本控制","aria-hidden":"true"}},[t._v("#")]),t._v(" 代码版本控制")]),n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("$ "),n("span",{attrs:{class:"token function"}},[t._v("git")]),t._v(" add -A\n$ "),n("span",{attrs:{class:"token function"}},[t._v("git")]),t._v(" commit -m "),n("span",{attrs:{class:"token string"}},[t._v("'locale'")]),t._v("\n")])])])}],e=a(0),o=Object(e.a)({},function(){this.$createElement;this._self._c;return this._m(0)},n,!1,null,null,null);s.default=o.exports},624:function(t,s,a){t.exports=a.p+"assets/img/8.3_6.16853f54.png"},625:function(t,s,a){t.exports=a.p+"assets/img/8.3_5.8b3f41ed.png"},626:function(t,s,a){t.exports=a.p+"assets/img/8.3_4.cbc534dc.png"},627:function(t,s,a){t.exports=a.p+"assets/img/8.3_3.c09e549f.png"},628:function(t,s,a){t.exports=a.p+"assets/img/8.3_2.7ecc185f.png"},629:function(t,s,a){t.exports=a.p+"assets/img/8.3_1.d83b8f90.png"}}]);