(window.webpackJsonp=window.webpackJsonp||[]).push([[269],{1340:function(t,s,a){"use strict";a.r(s);var n=[function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("div",{staticClass:"content"},[n("h1",{attrs:{id:"_3-3-微信登录"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-微信登录","aria-hidden":"true"}},[t._v("#")]),t._v(" 3.3 微信登录")]),n("h2",{attrs:{id:"安装-socialiteproviders"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#安装-socialiteproviders","aria-hidden":"true"}},[t._v("#")]),t._v(" 安装 socialiteproviders")]),n("p",[n("a",{attrs:{href:"https://socialiteproviders.github.io/",target:"_blank",rel:"noopener noreferrer"}},[t._v("socialiteproviders")]),t._v(" 为  Laravel Socialite 提供了更多的第三方登录方式，基本上你需要的，都能在这里找到。这个组件方便我们完成整个 OAuth 流程，不过对于我们开发接口来说，只用到了它部分的功能。\n首先找到 "),n("a",{attrs:{href:"http://socialiteproviders.github.io/providers/weixin.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("微信的provider")]),t._v("，一步步完成安装。")]),n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("$ composer require socialiteproviders/weixin\n")])]),n("p",[n("img",{attrs:{src:a(713),alt:"file"}})]),n("p",[t._v("因为我们使用了 laravel 5.5 所以可以省略 ServiceProvider 的设置。")]),n("p",[t._v("设置 "),n("code",[t._v("EventServiceProvider")])]),n("p",[n("em",[t._v("app/Providers/EventServiceProvider.php")])]),n("pre",{pre:!0,attrs:{class:"language-php"}},[n("code",[t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n "),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n "),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token keyword"}},[t._v("protected")]),t._v(" "),n("span",{attrs:{class:"token variable"}},[t._v("$listen")]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n  \\"),n("span",{attrs:{class:"token package"}},[t._v("SocialiteProviders"),n("span",{attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("Manager"),n("span",{attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("SocialiteWasCalled")]),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),n("span",{attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n    "),n("span",{attrs:{class:"token comment"}},[t._v("// add your listeners (aka providers) here")]),t._v("\n    "),n("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'SocialiteProviders\\Weixin\\WeixinExtendSocialite@handle'")]),t._v("\n  "),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n")])]),n("p",[t._v("好了，暂时只需要这两步，我们就能开始使用了。")]),n("h2",{attrs:{id:"功能调试"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#功能调试","aria-hidden":"true"}},[t._v("#")]),t._v(" 功能调试")]),n("p",[t._v("还记得上一章我们提到，客户端可能有两种实现方式, 我们先分别了解一下这两种情况，服务器端该如何处理。")]),n("h3",{attrs:{id:"_1-客户端已经获取-access-token"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-客户端已经获取-access-token","aria-hidden":"true"}},[t._v("#")]),t._v(" 1). 客户端已经获取 access_token")]),n("p",[t._v("因为客户端已经获取了 "),n("code",[t._v("access_token")]),t._v("，需要将 "),n("code",[t._v("access_token")]),t._v(" 发给服务器，服务器通过 "),n("code",[t._v("access_token")]),t._v(" 获取用户信息，如果成功的换取了用户信息则说明 "),n("code",[t._v("access_token")]),t._v(" 正确，用户微信登录成功。\n打开 tinker 开始调试")]),n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("$ php artisan tinker\n")])]),n("p",[t._v("我们上一章已经讲解了如何通过 "),n("code",[t._v("微信开发者工具")]),t._v(" 获取一个可用的 "),n("code",[t._v("access_token")]),t._v("，现在我们申请一个 "),n("code",[t._v("access_token")]),t._v("，然后在 tinker 中输入如下代码，将 "),n("code",[t._v("ACCESS_TOKEN")]),t._v(" 替换为你自己的。")]),n("pre",{pre:!0,attrs:{class:"language-php"}},[n("code",[n("span",{attrs:{class:"token variable"}},[t._v("$accessToken")]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'ACCESS_TOKEN'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{attrs:{class:"token variable"}},[t._v("$driver")]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" Socialite"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{attrs:{class:"token function"}},[t._v("driver")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'weixin'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{attrs:{class:"token variable"}},[t._v("$oauthUser")]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{attrs:{class:"token variable"}},[t._v("$driver")]),n("span",{attrs:{class:"token operator"}},[t._v("-")]),n("span",{attrs:{class:"token operator"}},[t._v(">")]),n("span",{attrs:{class:"token function"}},[t._v("userFromToken")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token variable"}},[t._v("$accessToken")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),n("p",[t._v("将以上代码贴到 Tinker 里执行：")]),n("p",[n("img",{attrs:{src:a(712),alt:"file"}})]),n("p",[t._v("我们看到报错了，这里是因为微信的流程中换取用户信息的接口，需要我们同时提交 "),n("code",[t._v("access_token")]),t._v(" 和 "),n("code",[t._v("openid")]),t._v("。\n"),n("img",{attrs:{src:a(711),alt:"file"}})]),n("p",[t._v("执行如下代码，替换 "),n("code",[t._v("OPEN_ID")]),t._v(" 为你自己的")]),n("pre",{pre:!0,attrs:{class:"language-php"}},[n("code",[n("span",{attrs:{class:"token variable"}},[t._v("$accessToken")]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'ACCESS_TOKEN'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{attrs:{class:"token variable"}},[t._v("$openID")]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'OPEN_ID'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{attrs:{class:"token variable"}},[t._v("$driver")]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" Socialite"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{attrs:{class:"token function"}},[t._v("driver")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'weixin'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{attrs:{class:"token variable"}},[t._v("$driver")]),n("span",{attrs:{class:"token operator"}},[t._v("-")]),n("span",{attrs:{class:"token operator"}},[t._v(">")]),n("span",{attrs:{class:"token function"}},[t._v("setOpenId")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token variable"}},[t._v("$openID")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{attrs:{class:"token variable"}},[t._v("$oauthUser")]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{attrs:{class:"token variable"}},[t._v("$driver")]),n("span",{attrs:{class:"token operator"}},[t._v("-")]),n("span",{attrs:{class:"token operator"}},[t._v(">")]),n("span",{attrs:{class:"token function"}},[t._v("userFromToken")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token variable"}},[t._v("$accessToken")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),n("p",[t._v("将以上代码贴到 Tinker 里执行：")]),n("p",[n("img",{attrs:{src:a(710),alt:"file"}})]),n("p",[t._v("请求成功，获取了用户信息")]),n("blockquote",[n("p",[t._v("只有微信获取用户信息需要同时使用 "),n("code",[t._v("access_token")]),t._v(" 及 "),n("code",[t._v("openid")]),t._v(" ，如果你开发的是微博等其他的第三方登录，并不需要 "),n("code",[t._v("$driver->setOpenId($openID);")]),t._v(" 这一步。")])]),n("h3",{attrs:{id:"_2-客户端只获取授权码（code）"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-客户端只获取授权码（code）","aria-hidden":"true"}},[t._v("#")]),t._v(" 2). 客户端只获取授权码（code）")]),n("p",[t._v("这种方式是推荐的安全做法，客户端不保存 "),n("code",[t._v("app_secret")]),t._v("，获取到授权码后就提交给服务器，服务器完成换取 "),n("code",[t._v("access_token")]),t._v(" 及换取用户信息的流程。\n使用这种方式，首先需要在服务端配置 "),n("code",[t._v("app_id")]),t._v(" 及 "),n("code",[t._v("app_secret")]),t._v("，修改如下")]),n("p",[n("em",[t._v("config/services.php")])]),n("pre",{pre:!0,attrs:{class:"language-php"}},[n("code",[n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'weixin'")]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),n("span",{attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n    "),n("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'client_id'")]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),n("span",{attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("env")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'WEIXIN_KEY'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),n("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'client_secret'")]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),n("span",{attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("env")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'WEIXIN_SECRET'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),n("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'redirect'")]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),n("span",{attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("env")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'WEIXIN_REDIRECT_URI'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("  \n"),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" \n")])]),n("p",[n("em",[t._v(".env")])]),n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{attrs:{class:"token keyword"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token keyword"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token keyword"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token comment"}},[t._v("# socialite weixin")]),t._v("\nWEIXIN_KEY"),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v("wx353901f6*****\nWEIXIN_SECRET"),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v("d4624c36b6795d1d9******\n")])]),n("p",[t._v("注意将 "),n("code",[t._v("WEIXIN_KEY")]),t._v(" 和 "),n("code",[t._v("WEIXIN_SECRET")]),t._v(" 替换为你自己的 "),n("code",[t._v("appId")]),t._v(" 和 "),n("code",[t._v("appsecret")])]),n("p",[t._v("打开 tinker")]),n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("$ php artisan tinker\n")])]),n("p",[t._v("通过 "),n("code",[t._v("微信开发者工具")]),t._v(" 获取一个 code，执行如下代码，将 CODE 替换成你自己的")]),n("pre",{pre:!0,attrs:{class:"language-php"}},[n("code",[n("span",{attrs:{class:"token variable"}},[t._v("$code")]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'CODE'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{attrs:{class:"token variable"}},[t._v("$driver")]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" Socialite"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{attrs:{class:"token function"}},[t._v("driver")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'weixin'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{attrs:{class:"token variable"}},[t._v("$response")]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{attrs:{class:"token variable"}},[t._v("$driver")]),n("span",{attrs:{class:"token operator"}},[t._v("-")]),n("span",{attrs:{class:"token operator"}},[t._v(">")]),n("span",{attrs:{class:"token function"}},[t._v("getAccessTokenResponse")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token variable"}},[t._v("$code")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{attrs:{class:"token variable"}},[t._v("$driver")]),n("span",{attrs:{class:"token operator"}},[t._v("-")]),n("span",{attrs:{class:"token operator"}},[t._v(">")]),n("span",{attrs:{class:"token function"}},[t._v("setOpenId")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token variable"}},[t._v("$response")]),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'openid'")]),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{attrs:{class:"token variable"}},[t._v("$oauthUser")]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{attrs:{class:"token variable"}},[t._v("$driver")]),n("span",{attrs:{class:"token operator"}},[t._v("-")]),n("span",{attrs:{class:"token operator"}},[t._v(">")]),n("span",{attrs:{class:"token function"}},[t._v("userFromToken")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token variable"}},[t._v("$response")]),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'access_token'")]),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),n("p",[t._v("将以上代码贴到 Tinker 里执行：")]),n("p",[n("img",{attrs:{src:a(709),alt:"file"}})]),n("p",[t._v("可以看到，我们通过授权码，成功获取了 "),n("code",[t._v("access_token")]),t._v(" 和 "),n("code",[t._v("openid")]),t._v("，然后换取了用户信息。")]),n("blockquote",[n("p",[t._v("处于安全的考虑，授权码只能使用一次")])]),n("h2",{attrs:{id:"第三方登录处理流程"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#第三方登录处理流程","aria-hidden":"true"}},[t._v("#")]),t._v(" 第三方登录处理流程")]),n("p",[t._v("最终服务器获取了用户在微信的用户信息，这一点很重要，无论使用上面哪种方式，都一定要保证用户数据是服务器自己通过 "),n("code",[t._v("access_token")]),t._v(" 获取的，还有这样才能验证客户端提交数据（ code 或 access_token ）的真实性。获取到的用户数据如下")]),n("pre",{pre:!0,attrs:{class:"language-php"}},[n("code",[t._v("user"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n   "),n("span",{attrs:{class:"token double-quoted-string string"}},[t._v('"openid"')]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),n("span",{attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),n("span",{attrs:{class:"token double-quoted-string string"}},[t._v('"xxxxxxx"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n   "),n("span",{attrs:{class:"token double-quoted-string string"}},[t._v('"nickname"')]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),n("span",{attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),n("span",{attrs:{class:"token double-quoted-string string"}},[t._v('"xxx"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n   "),n("span",{attrs:{class:"token double-quoted-string string"}},[t._v('"sex"')]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),n("span",{attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),n("span",{attrs:{class:"token number"}},[t._v("1")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n   "),n("span",{attrs:{class:"token double-quoted-string string"}},[t._v('"language"')]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),n("span",{attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),n("span",{attrs:{class:"token double-quoted-string string"}},[t._v('"zh_CN"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n   "),n("span",{attrs:{class:"token double-quoted-string string"}},[t._v('"city"')]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),n("span",{attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),n("span",{attrs:{class:"token double-quoted-string string"}},[t._v('"成都"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n   "),n("span",{attrs:{class:"token double-quoted-string string"}},[t._v('"province"')]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),n("span",{attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),n("span",{attrs:{class:"token double-quoted-string string"}},[t._v('"四川"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n   "),n("span",{attrs:{class:"token double-quoted-string string"}},[t._v('"country"')]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),n("span",{attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),n("span",{attrs:{class:"token double-quoted-string string"}},[t._v('"中国"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n   "),n("span",{attrs:{class:"token double-quoted-string string"}},[t._v('"headimgurl"')]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),n("span",{attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),n("span",{attrs:{class:"token double-quoted-string string"}},[t._v('"avatar"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n   "),n("span",{attrs:{class:"token double-quoted-string string"}},[t._v('"privilege"')]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),n("span",{attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n   "),n("span",{attrs:{class:"token double-quoted-string string"}},[t._v('"unionid"')]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),n("span",{attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),n("span",{attrs:{class:"token double-quoted-string string"}},[t._v('"xxxxxx"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n "),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])]),n("p",[t._v("现在两种情况")]),n("ol",[n("li",[t._v("用户第一次使用微信登录，根据微信的数据，在 Larabbs 中创建一个用户，返回该用户的登录凭证")]),n("li",[t._v("用户已经使用过微信登录，则找到数据库中对应的用户，返回该用户的登录凭证")])]),n("p",[t._v("那么如何来分辨用户是否已存在，就需要一个用户的唯一标识。任何一个第三方平台，返回的用户信息都会有一个唯一标识，"),n("code",[t._v("socialite")]),t._v(" 已经为我们封装好了，直接使用 "),n("code",[t._v("$oauthUser->getId()")]),t._v(" 即可获取，对于微信来说，这个唯一标识叫做"),n("code",[t._v("openid")]),t._v("。不过微信还有一个 "),n("code",[t._v("unionid")]),t._v(" 的概念，大家可以看一下 Summer "),n("a",{attrs:{href:"https://www.zhihu.com/question/21762191/answer/266774632",target:"_blank",rel:"noopener noreferrer"}},[t._v("这里")]),t._v(" 的回答。")]),n("p",[t._v("微信关于unionid的解释")]),n("blockquote",[n("p",[t._v("如果开发者拥有多个移动应用、网站应用、和公众帐号（包括小程序），可通过 unionid 来区分用户的唯一性，因为只要是同一个微信开放平台帐号下的移动应用、网站应用和公众帐号（包括小程序），用户的 unionid 是唯一的。换句话说，同一用户，对同一个微信开放平台下的不同应用，unionid 是相同的。")])]),n("p",[t._v("所以我们的处理如下")]),n("ul",[n("li",[t._v("根据用户的 openid/unionid 查找数据库中已存在的用户")]),n("li",[t._v("用户存在，返回该用户的登录凭证")]),n("li",[t._v("用户不存在，根据微信信息创建用户，返回该用户的登录凭证")])]),n("h2",{attrs:{id:"提交代码"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#提交代码","aria-hidden":"true"}},[t._v("#")]),t._v(" 提交代码")]),n("p",[t._v("下一节我们完成代码的开发， 先提交一下代码")]),n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("$ "),n("span",{attrs:{class:"token function"}},[t._v("git")]),t._v(" add -A\n$ "),n("span",{attrs:{class:"token function"}},[t._v("git")]),t._v(" commit -m "),n("span",{attrs:{class:"token string"}},[t._v('"add socialiteproviders"')]),t._v("\n")])])])}],e=a(0),o=Object(e.a)({},function(){this.$createElement;this._self._c;return this._m(0)},n,!1,null,null,null);s.default=o.exports},709:function(t,s,a){t.exports=a.p+"assets/img/3.3_5.f96a9b08.png"},710:function(t,s,a){t.exports=a.p+"assets/img/3.3_4.4dbe5af2.png"},711:function(t,s,a){t.exports=a.p+"assets/img/3.3_3.75b23a10.png"},712:function(t,s,a){t.exports=a.p+"assets/img/3.3_2.25994289.png"},713:function(t,s,a){t.exports=a.p+"assets/img/3.3_1.11b68c01.png"}}]);