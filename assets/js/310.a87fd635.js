(window.webpackJsonp=window.webpackJsonp||[]).push([[310],{1402:function(t,s,a){"use strict";a.r(s);var n=[function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("div",{staticClass:"content"},[n("h1",{attrs:{id:"_5-4-邮件通知"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-4-邮件通知","aria-hidden":"true"}},[t._v("#")]),t._v(" 5.4 邮件通知")]),n("p",[t._v("本章节我们将为『话题有新回复』通知新增『邮件通知频道』，当话题被回复时，作者可以收到一份 Email 邮件通知。Laravel 的通知系统默认支持邮件频道的通知方式，我们只需要稍作配置即可。")]),n("p",[t._v("Laravel 支持多种邮件驱动，包括 smtp、Mailgun、Maildrill、Amazon SES、mail 和 sendmail。Mailgun 、 Amazon SES 、Maildrill 都是第三方邮件服务。mail 驱动使用 PHP 提供的 mail 函数。sendmail 驱动通过 Sendmail/Postfix（Linux）提供的命令发送邮件，smtp 驱动使用支持 ESMTP 的 SMTP 服务器发送邮件。mail 不安全，sendmail 需要安装配置 Sendmail/Postfix，并且信用不高，很容易被当成垃圾邮件，第三方服务的信用是最高的，商业软件推荐使用。")]),n("p",[t._v("本章节以 QQ 邮箱为例，我们将开启 QQ 的 SMTP 功能，并配置项目的 SMTP 邮件发送功能。其他邮箱的配置基本大致相同。")]),n("h2",{attrs:{id:"_1-开启-qq-邮箱的-smtp-支持"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-开启-qq-邮箱的-smtp-支持","aria-hidden":"true"}},[t._v("#")]),t._v(" 1. 开启 QQ 邮箱的 SMTP 支持")]),n("p",[t._v("首先我们需要在 QQ 邮箱的账号设置里开启 POP3 和 SMTP 服务。具体请查看 "),n("a",{attrs:{href:"http://service.mail.qq.com/cgi-bin/help?subtype=1&id=28&no=166",target:"_blank",rel:"noopener noreferrer"}},[t._v("如何打开POP3/SMTP/IMAP功能？")]),t._v(" 。")]),n("p",[t._v("只需要开启以下：")]),n("p",[n("img",{attrs:{src:a(862),alt:"file"}})]),n("p",[t._v("复制方框里的『授权码』，授权码将作为我们的密码使用：")]),n("p",[n("img",{attrs:{src:a(861),alt:"file"}})]),n("h2",{attrs:{id:"_2-邮箱发送配置"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-邮箱发送配置","aria-hidden":"true"}},[t._v("#")]),t._v(" 2. 邮箱发送配置")]),n("p",[t._v("Laravel 中邮箱发送的配置存放于 "),n("code",[t._v("config/mail.php")]),t._v(" 中。不过 "),n("code",[t._v("mail.php")]),t._v(" 中我们所需的配置，都可以通过 "),n("code",[t._v(".env")]),t._v(" 来配置。作为最佳实践，我们优先选择通过环境变量来配置：")]),n("p",[n("em",[t._v(".env")])]),n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[n("span",{attrs:{class:"token keyword"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token keyword"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token keyword"}},[t._v(".")]),t._v("\nMAIL_DRIVER"),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v("smtp\nMAIL_HOST"),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v("smtp.qq.com\nMAIL_PORT"),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v("25\nMAIL_USERNAME"),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v("xxxxxxxxxxxxxx@qq.com\nMAIL_PASSWORD"),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v("xxxxxxxxx\nMAIL_ENCRYPTION"),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v("tls\nMAIL_FROM_ADDRESS"),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v("xxxxxxxxxxxxxx@qq.com\nMAIL_FROM_NAME"),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v("LaraBBS\n"),n("span",{attrs:{class:"token keyword"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token keyword"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token keyword"}},[t._v(".")]),t._v("\n")])]),n("p",[t._v("选项讲解：")]),n("ol",[n("li",[t._v("MAIL_DRIVER=smtp —— 使用支持 ESMTP 的 SMTP 服务器发送邮件；")]),n("li",[t._v("MAIL_HOST=smtp.qq.com —— QQ 邮箱的 SMTP 服务器地址，必须为此值；")]),n("li",[t._v("MAIL_PORT=25 —— QQ 邮箱的 SMTP 服务器端口，必须为此值；")]),n("li",[t._v("MAIL_USERNAME=xxxxxxxxxxxxxx@qq.com —— 请将此值换为你的 QQ + "),n("code",[t._v("@qq.com")]),t._v("；")]),n("li",[t._v("MAIL_PASSWORD=xxxxxxxxx —— 密码是我们第一步拿到的授权码；")]),n("li",[t._v("MAIL_ENCRYPTION=tls —— 加密类型，选项 null 表示不使用任何加密，其他选项还有 ssl，这里我们使用 tls 即可。")]),n("li",[t._v("MAIL_FROM_ADDRESS=xxxxxxxxxxxxxx@qq.com —— 此值必须同 MAIL_USERNAME 一致；")]),n("li",[t._v("MAIL_FROM_NAME=LaraBBS —— 用来作为邮件的发送者名称。")])]),n("h2",{attrs:{id:"_3-添加邮件通知频道"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-添加邮件通知频道","aria-hidden":"true"}},[t._v("#")]),t._v(" 3. 添加邮件通知频道")]),n("p",[t._v("首先我们需要修改 "),n("code",[t._v("via()")]),t._v(" 方法，并新增 "),n("code",[t._v("mail")]),t._v(" 通知频道：")]),n("p",[n("em",[t._v("app/Notifications/TopicReplied.php")])]),n("pre",{pre:!0,attrs:{class:"language-php"}},[n("code",[n("span",{attrs:{class:"token php language-php"}},[n("span",{attrs:{class:"token delimiter important"}},[t._v("<?php")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),n("span",{attrs:{class:"token class-name"}},[t._v("TopicReplied")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("extends")]),t._v(" "),n("span",{attrs:{class:"token class-name"}},[t._v("Notification")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n    "),n("span",{attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("via")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token variable"}},[t._v("$notifiable")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),n("span",{attrs:{class:"token comment"}},[t._v("// 开启通知的频道")]),t._v("\n        "),n("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'database'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'mail'")]),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("p",[t._v("因为开启了 "),n("code",[t._v("mail")]),t._v(" 频道，我们还需要新增 "),n("code",[t._v("toMail")]),t._v(" 方法：")]),n("p",[n("em",[t._v("app/Notifications/TopicReplied.php")])]),n("pre",{pre:!0,attrs:{class:"language-php"}},[n("code",[n("span",{attrs:{class:"token php language-php"}},[n("span",{attrs:{class:"token delimiter important"}},[t._v("<?php")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),n("span",{attrs:{class:"token class-name"}},[t._v("TopicReplied")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("extends")]),t._v(" "),n("span",{attrs:{class:"token class-name"}},[t._v("Notification")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n    \n    "),n("span",{attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("toMail")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token variable"}},[t._v("$notifiable")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),n("span",{attrs:{class:"token variable"}},[t._v("$url")]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{attrs:{class:"token variable"}},[t._v("$this")]),n("span",{attrs:{class:"token operator"}},[t._v("-")]),n("span",{attrs:{class:"token operator"}},[t._v(">")]),n("span",{attrs:{class:"token property"}},[t._v("reply")]),n("span",{attrs:{class:"token operator"}},[t._v("-")]),n("span",{attrs:{class:"token operator"}},[t._v(">")]),n("span",{attrs:{class:"token property"}},[t._v("topic")]),n("span",{attrs:{class:"token operator"}},[t._v("-")]),n("span",{attrs:{class:"token operator"}},[t._v(">")]),n("span",{attrs:{class:"token function"}},[t._v("link")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'#reply'")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v(" "),n("span",{attrs:{class:"token variable"}},[t._v("$this")]),n("span",{attrs:{class:"token operator"}},[t._v("-")]),n("span",{attrs:{class:"token operator"}},[t._v(">")]),n("span",{attrs:{class:"token property"}},[t._v("reply")]),n("span",{attrs:{class:"token operator"}},[t._v("-")]),n("span",{attrs:{class:"token operator"}},[t._v(">")]),n("span",{attrs:{class:"token property"}},[t._v("id")]),n("span",{attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n        "),n("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),n("span",{attrs:{class:"token class-name"}},[t._v("MailMessage")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n            "),n("span",{attrs:{class:"token operator"}},[t._v("-")]),n("span",{attrs:{class:"token operator"}},[t._v(">")]),n("span",{attrs:{class:"token function"}},[t._v("line")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'你的话题有新回复！'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n            "),n("span",{attrs:{class:"token operator"}},[t._v("-")]),n("span",{attrs:{class:"token operator"}},[t._v(">")]),n("span",{attrs:{class:"token function"}},[t._v("action")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'查看回复'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token variable"}},[t._v("$url")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("h2",{attrs:{id:"_4-测试邮件通知"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-测试邮件通知","aria-hidden":"true"}},[t._v("#")]),t._v(" 4. 测试邮件通知")]),n("p",[t._v("首先我们利用数据库工具修改 ID 为 1 的用户邮箱为你自己的 QQ 邮箱（或者你自己的其他邮箱账号也可），这样我们才能更加直观地检测邮件是否发送成功：")]),n("p",[n("img",{attrs:{src:a(860),alt:"file"}})]),n("p",[t._v("登录除了 ID 为 1 的用户，并寻找 Summer 发布的话题进行回复提交：")]),n("p",[n("img",{attrs:{src:a(859),alt:"file"}})]),n("p",[t._v("提交成功后，刷新邮箱，一般几分钟内就能收到话题回复的邮件：")]),n("p",[n("img",{attrs:{src:a(858),alt:"file"}})]),n("h2",{attrs:{id:"_5-使用队列发送邮件"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-使用队列发送邮件","aria-hidden":"true"}},[t._v("#")]),t._v(" 5. 使用队列发送邮件")]),n("p",[t._v("大家应该会发现我们提交回复时，服务器响应会变得非常缓慢，这是『邮件通知』功能请求了 QQ SMTP 服务器进行邮件发送所产生的延迟。我们已经学过了，对于处理此类延迟，最好的方式是使用队列系统。")]),n("p",[t._v("我们可以通过对通知类添加 ShouldQueue 接口和 Queueable trait 把通知加入队列。它们两个在使用 "),n("code",[t._v("make:notification")]),t._v(" 命令来生成通知文件时就已经被导入，我们只需添加到通知类接口即可。")]),n("p",[t._v("修改 "),n("code",[t._v("TopicReplied.php")]),t._v(" 文件，将以下这一行：")]),n("pre",{pre:!0,attrs:{class:"language-php"}},[n("code",[n("span",{attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),n("span",{attrs:{class:"token class-name"}},[t._v("TopicReplied")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("extends")]),t._v(" "),n("span",{attrs:{class:"token class-name"}},[t._v("Notification")]),t._v("\n")])]),n("p",[t._v("改为：")]),n("pre",{pre:!0,attrs:{class:"language-php"}},[n("code",[n("span",{attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),n("span",{attrs:{class:"token class-name"}},[t._v("TopicReplied")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("extends")]),t._v(" "),n("span",{attrs:{class:"token class-name"}},[t._v("Notification")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("implements")]),t._v(" "),n("span",{attrs:{class:"token class-name"}},[t._v("ShouldQueue")]),t._v("\n")])]),n("p",[t._v("Laravel 会检测 "),n("code",[t._v("ShouldQueue")]),t._v(" 接口并自动将通知的发送放入队列中，所以我们不需要做其他修改。")]),n("h3",{attrs:{id:"测试下队列"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#测试下队列","aria-hidden":"true"}},[t._v("#")]),t._v(" 测试下队列")]),n("p",[t._v("将 QUEUE_DRIVER 的值改为 redis：")]),n("p",[n("em",[t._v(".env")])]),n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("QUEUE_DRIVER"),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v("redis\n")])]),n("p",[t._v("命令行运行队列监控：")]),n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("$ php artisan horizon\n")])]),n("p",[t._v("发送邮件测试，可以发现速度大大提高，队列监控也接收到队列任务，并成功处理：")]),n("p",[n("img",{attrs:{src:a(857),alt:"file"}})]),n("p",[t._v("测试成功后，为了简化后续的开发，我们将配置改为原来的 sync 实时模式：")]),n("p",[n("em",[t._v(".env")])]),n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("QUEUE_DRIVER"),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v("sync\n")])]),n("h2",{attrs:{id:"git-版本控制"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#git-版本控制","aria-hidden":"true"}},[t._v("#")]),t._v(" Git 版本控制")]),n("p",[t._v("下面把代码纳入到版本管理：")]),n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("$ "),n("span",{attrs:{class:"token function"}},[t._v("git")]),t._v(" add -A\n$ "),n("span",{attrs:{class:"token function"}},[t._v("git")]),t._v(" commit -m "),n("span",{attrs:{class:"token string"}},[t._v('"Notify user in email with Queue supported"')]),t._v("\n")])])])}],e=a(0),r=Object(e.a)({},function(){this.$createElement;this._self._c;return this._m(0)},n,!1,null,null,null);s.default=r.exports},857:function(t,s,a){t.exports=a.p+"assets/img/5.4_6.491074fc.gif"},858:function(t,s,a){t.exports=a.p+"assets/img/5.4_5.adb56558.png"},859:function(t,s,a){t.exports=a.p+"assets/img/5.4_4.e8e4abf6.png"},860:function(t,s,a){t.exports=a.p+"assets/img/5.4_3.a8253e9c.png"},861:function(t,s,a){t.exports=a.p+"assets/img/5.4_2.71feefe7.png"},862:function(t,s,a){t.exports=a.p+"assets/img/5.4_1.622dd007.png"}}]);