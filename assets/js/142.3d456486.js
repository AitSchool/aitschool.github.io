(window.webpackJsonp=window.webpackJsonp||[]).push([[142],{1347:function(e,n,t){"use strict";t.r(n);var r=[function(){var e=this,n=e.$createElement,r=e._self._c||n;return r("div",{staticClass:"content"},[r("h2",{attrs:{id:"_7-7拒绝退款"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_7-7拒绝退款","aria-hidden":"true"}},[e._v("#")]),e._v(" 7.7拒绝退款")]),r("p",[e._v("接下来我们要实现管理后台处理用户退款申请的功能，我们先来实现拒绝用户的退款申请。")]),r("h2",{attrs:{id:"_1-控制器"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_1-控制器","aria-hidden":"true"}},[e._v("#")]),e._v(" 1. 控制器")]),r("p",[e._v("我们先创建一个 "),r("code",[e._v("HandleRefundRequest")]),e._v(" 来校验运营人员处理退款的请求：")]),r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v("$ php artisan make:request Admin/HandleRefundRequest\n")])]),r("p",[r("em",[e._v("app/Http/Requests/Admin/HandleRefundRequest.php")])]),r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v("<?php\n\nnamespace App\\Http\\Requests\\Admin;\n\nuse App\\Http\\Requests\\Request;\n\nclass HandleRefundRequest extends Request\n{\n    public function rules()\n    {\n        return [\n            'agree'  => ['required', 'boolean'],\n            'reason' => ['required_if:agree,false'], // 拒绝退款时需要输入拒绝理由\n        ];\n    }\n}\n")])]),r("p",[e._v("然后在 "),r("code",[e._v("OrdersController")]),e._v(" 中添加 "),r("code",[e._v("handleRefund()")]),e._v(" 方法作为处理退款的接口：")]),r("p",[r("em",[e._v("app/Admin/Controllers/OrdersController.php")])]),r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v("use App\\Http\\Requests\\Admin\\HandleRefundRequest;\n.\n.\n.\n    public function handleRefund(Order $order, HandleRefundRequest $request)\n    {\n      // 判断订单状态是否正确\n        if ($order->refund_status !== Order::REFUND_STATUS_APPLIED) {\n            throw new InvalidRequestException('订单状态不正确');\n        }\n    // 是否同意退款\n        if ($request->input('agree')) {\n        // 同意退款的逻辑这里先留空\n            // todo\n        } else {\n        // 将拒绝退款理由放到订单的 extra 字段中\n            $extra = $order->extra ?: [];\n            $extra['refund_disagree_reason'] = $request->input('reason');\n      // 将订单的退款状态改为未退款\n            $order->update([\n                'refund_status' => Order::REFUND_STATUS_PENDING,\n                'extra'         => $extra,\n            ]);\n        }\n\n        return $order;\n    }\n")])]),r("h2",{attrs:{id:"_2-路由"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_2-路由","aria-hidden":"true"}},[e._v("#")]),e._v(" 2. 路由")]),r("p",[e._v("然后添加对应的路由：")]),r("p",[r("em",[e._v("app/Admin/routes.php")])]),r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v("$router->post('orders/{order}/refund', 'OrdersController@handleRefund')->name('admin.orders.handle_refund');\n")])]),r("h2",{attrs:{id:"_3-前端模板"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_3-前端模板","aria-hidden":"true"}},[e._v("#")]),e._v(" 3. 前端模板")]),r("p",[e._v("接下来我们需要在后台的订单详情页里添加处理退款的按钮，把退款信息放在表格的最下方：")]),r("p",[r("em",[e._v("resources/views/admin/orders/show.blade.php")])]),r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v(".\n.\n.\n<tbody>\n  .\n  .\n  .\n  @if($order->refund_status !== \\App\\Models\\Order::REFUND_STATUS_PENDING)\n  <tr>\n    <td>退款状态：</td>\n    <td colspan=\"2\">{{ \\App\\Models\\Order::$refundStatusMap[$order->refund_status] }}，理由：{{ $order->extra['refund_reason'] }}</td>\n    <td>\n    \x3c!-- 如果订单退款状态是已申请，则展示处理按钮 --\x3e\n    @if($order->refund_status === \\App\\Models\\Order::REFUND_STATUS_APPLIED)\n      <button class=\"btn btn-sm btn-success\" id=\"btn-refund-agree\">同意</button>\n      <button class=\"btn btn-sm btn-danger\" id=\"btn-refund-disagree\">不同意</button>\n    @endif\n    </td>\n  </tr>\n  @endif\n</tbody>\n.\n.\n.\n<script>\n$(document).ready(function() {\n  // 不同意 按钮的点击事件\n  $('#btn-refund-disagree').click(function() {\n  // 注意：Laravel-Admin 的 swal 是 v1 版本，参数和 v2 版本的不太一样\n    swal({\n      title: '输入拒绝退款理由',\n      type: 'input',\n      showCancelButton: true,\n      closeOnConfirm: false,\n      confirmButtonText: \"确认\",\n      cancelButtonText: \"取消\",\n    }, function(inputValue){\n      // 用户点击了取消，inputValue 为 false\n      // === 是为了区分用户点击取消还是没有输入\n      if (inputValue === false) {\n        return;\n      }\n      if (!inputValue) {\n        swal('理由不能为空', '', 'error')\n        return;\n      }\n      // Laravel-Admin 没有 axios，使用 jQuery 的 ajax 方法来请求\n      $.ajax({\n        url: '{{ route('admin.orders.handle_refund', [$order->id]) }}',\n        type: 'POST',\n        data: JSON.stringify({   // 将请求变成 JSON 字符串\n          agree: false,  // 拒绝申请\n          reason: inputValue,\n          // 带上 CSRF Token\n          // Laravel-Admin 页面里可以通过 LA.token 获得 CSRF Token\n          _token: LA.token,\n        }),\n        contentType: 'application/json',  // 请求的数据格式为 JSON\n        success: function (data) {  // 返回成功时会调用这个函数\n          swal({\n            title: '操作成功',\n            type: 'success'\n          }, function() {\n            // 用户点击 swal 上的 按钮时刷新页面\n            location.reload();\n          });\n        }\n      });\n    });\n  });\n});\n<\/script>\n")])]),r("h2",{attrs:{id:"_4-测试"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_4-测试","aria-hidden":"true"}},[e._v("#")]),e._v(" 4. 测试")]),r("p",[e._v("接下来我们测试一下，在后台的订单列表页面找到申请退款的那笔订单，进入详情页：")]),r("p",[r("img",{attrs:{src:t(193),alt:"file"}})]),r("p",[e._v("点击 "),r("code",[e._v("不同意")]),e._v(" 按钮：")]),r("p",[r("img",{attrs:{src:t(192),alt:"file"}})]),r("p",[e._v("输入拒绝退款理由，点击 "),r("code",[e._v("确认")]),e._v(" 按钮：")]),r("p",[r("img",{attrs:{src:t(191),alt:"file"}})]),r("p",[e._v("点击 "),r("code",[e._v("OK")]),e._v(" 之后页面自动刷新：")]),r("p",[r("img",{attrs:{src:t(190),alt:"file"}})]),r("p",[e._v("已经没有退款的信息了。")]),r("h2",{attrs:{id:"_5-细节优化"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_5-细节优化","aria-hidden":"true"}},[e._v("#")]),e._v(" 5. 细节优化")]),r("p",[e._v("接下来我们需要在用户界面展示拒绝退款理由。")]),r("p",[r("em",[e._v("resources/views/orders/show.blade.php")])]),r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v(".\n.\n.\n        <div>\n          <span>订单状态：</span>\n          <div class=\"value\">\n            .\n      .\n      .\n          </div>\n        </div>\n        @if(isset($order->extra['refund_disagree_reason']))\n        <div>\n          <span>拒绝退款理由：</span>\n          <div class=\"value\">{{ $order->extra['refund_disagree_reason'] }}</div>\n        </div>\n        @endif\n.\n.\n.\n")])]),r("p",[e._v("再访问用户界面的订单详情页：")]),r("p",[r("img",{attrs:{src:t(189),alt:"file"}})]),r("h2",{attrs:{id:"git-代码版本控制"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#git-代码版本控制","aria-hidden":"true"}},[e._v("#")]),e._v(" Git 代码版本控制")]),r("p",[e._v("接着让我们将这些文件加入到版本控制中：")]),r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v('$ git add -A\n$ git commit -m "管理后台 - 拒绝退款"\n')])])])}],a=t(0),s=Object(a.a)({},function(){this.$createElement;this._self._c;return this._m(0)},r,!1,null,null,null);n.default=s.exports},189:function(e,n,t){e.exports=t.p+"assets/img/7.7_5.e8e7c72b.png"},190:function(e,n,t){e.exports=t.p+"assets/img/7.7_4.1b6134b0.png"},191:function(e,n,t){e.exports=t.p+"assets/img/7.7_3.a935ddff.png"},192:function(e,n,t){e.exports=t.p+"assets/img/7.7_2.b62d1020.png"},193:function(e,n,t){e.exports=t.p+"assets/img/7.7_1.6d1ddae4.png"}}]);