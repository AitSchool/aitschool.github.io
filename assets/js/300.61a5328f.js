(window.webpackJsonp=window.webpackJsonp||[]).push([[300],{1387:function(t,s,a){"use strict";a.r(s);var n=[function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("div",{staticClass:"content"},[n("h1",{attrs:{id:"_6-8-访问权限"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_6-8-访问权限","aria-hidden":"true"}},[t._v("#")]),t._v(" 6.8 访问权限")]),n("p",[t._v("开发后台时，不论是 "),n("code",[t._v("administrator.php")]),t._v(" 里、模型配置文件中或者站点配置信息里，我们都有设置到 "),n("code",[t._v("permission")]),t._v(" 选项，不过一直没有测试其有效性。这个章节我们统一做测试。")]),n("p",[t._v("1 号用户 Summer 是站长权限，拥有所有权限，所以不需要测试。接下来我们将切换到第 2 号用户管理员角色和第 3 号普通用户角色进行测试。")]),n("p",[t._v("首先测试 3 号用户，检测是否能进入后台：")]),n("p",[n("img",{attrs:{src:a(828),alt:"file"}})]),n("p",[t._v("3 号用户无法登录后台，被跳转到首页。事实上，根据 "),n("code",[t._v("administrator.php")]),t._v(" 里的配置，当 "),n("code",[t._v("permission")]),t._v(" 选项判断不通过后，会重定向到 "),n("code",[t._v("login")]),t._v(" 页面，"),n("code",[t._v("login")]),t._v(" 页面检测到用户已经登录，就跳转到首页。这个用户体验不好，接下来我们开发一个无权限访问后台的提醒页面。")]),n("h2",{attrs:{id:"无权限提醒页面"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#无权限提醒页面","aria-hidden":"true"}},[t._v("#")]),t._v(" 无权限提醒页面")]),n("h3",{attrs:{id:"_1-新建路由"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-新建路由","aria-hidden":"true"}},[t._v("#")]),t._v(" 1. 新建路由")]),n("p",[n("em",[t._v("routes/web.php")])]),n("pre",{pre:!0,attrs:{class:"language-php"}},[n("code",[n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n\nRoute"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{attrs:{class:"token function"}},[t._v("get")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'permission-denied'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'PagesController@permissionDenied'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token operator"}},[t._v("-")]),n("span",{attrs:{class:"token operator"}},[t._v(">")]),n("span",{attrs:{class:"token function"}},[t._v("name")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'permission-denied'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),n("h3",{attrs:{id:"_2-administrator-配置修改"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-administrator-配置修改","aria-hidden":"true"}},[t._v("#")]),t._v(" 2. Administrator 配置修改")]),n("p",[n("em",[t._v("config/administrator.php")])]),n("pre",{pre:!0,attrs:{class:"language-php"}},[n("code",[n("span",{attrs:{class:"token php language-php"}},[n("span",{attrs:{class:"token delimiter important"}},[t._v("<?php")]),t._v("\n\n"),n("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("array")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n    "),n("span",{attrs:{class:"token comment"}},[t._v("// 当选项 `permission` 权限检测不通过时，会重定向用户到此处设置的路径")]),t._v("\n    "),n("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'login_path'")]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),n("span",{attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),n("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'permission-denied'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),n("h3",{attrs:{id:"_3-新增控制器方法"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-新增控制器方法","aria-hidden":"true"}},[t._v("#")]),t._v(" 3. 新增控制器方法")]),n("p",[n("em",[t._v("app/Http/Controllers/PagesController.php")])]),n("pre",{pre:!0,attrs:{class:"language-php"}},[n("code",[n("span",{attrs:{class:"token php language-php"}},[n("span",{attrs:{class:"token delimiter important"}},[t._v("<?php")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),n("span",{attrs:{class:"token class-name"}},[t._v("PagesController")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("extends")]),t._v(" "),n("span",{attrs:{class:"token class-name"}},[t._v("Controller")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n  \n    "),n("span",{attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("permissionDenied")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),n("span",{attrs:{class:"token comment"}},[t._v("// 如果当前用户有权限访问后台，直接跳转访问")]),t._v("\n        "),n("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token function"}},[t._v("config")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'administrator.permission'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),n("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("redirect")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token function"}},[t._v("url")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token function"}},[t._v("config")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'administrator.uri'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token number"}},[t._v("302")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n        "),n("span",{attrs:{class:"token comment"}},[t._v("// 否则使用视图")]),t._v("\n        "),n("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("view")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'pages.permission_denied'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("h3",{attrs:{id:"_4-视图文件"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-视图文件","aria-hidden":"true"}},[t._v("#")]),t._v(" 4. 视图文件")]),n("p",[n("em",[t._v("resources/views/pages/permission_denied.blade.php")])]),n("pre",{pre:!0,attrs:{class:"language-php"}},[n("code",[t._v("@"),n("span",{attrs:{class:"token keyword"}},[t._v("extends")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'layouts.app'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n@"),n("span",{attrs:{class:"token function"}},[t._v("section")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'title'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'无权限访问'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n@"),n("span",{attrs:{class:"token function"}},[t._v("section")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'content'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),n("span",{attrs:{class:"token operator"}},[t._v("<")]),t._v("div "),n("span",{attrs:{class:"token keyword"}},[t._v("class")]),n("span",{attrs:{class:"token operator"}},[t._v("=")]),n("span",{attrs:{class:"token double-quoted-string string"}},[t._v('"col-md-4 col-md-offset-4"')]),n("span",{attrs:{class:"token operator"}},[t._v(">")]),t._v("\n    "),n("span",{attrs:{class:"token operator"}},[t._v("<")]),t._v("div "),n("span",{attrs:{class:"token keyword"}},[t._v("class")]),n("span",{attrs:{class:"token operator"}},[t._v("=")]),n("span",{attrs:{class:"token double-quoted-string string"}},[t._v('"panel panel-default"')]),n("span",{attrs:{class:"token operator"}},[t._v(">")]),t._v("\n        "),n("span",{attrs:{class:"token operator"}},[t._v("<")]),t._v("div "),n("span",{attrs:{class:"token keyword"}},[t._v("class")]),n("span",{attrs:{class:"token operator"}},[t._v("=")]),n("span",{attrs:{class:"token double-quoted-string string"}},[t._v('"panel-body"')]),n("span",{attrs:{class:"token operator"}},[t._v(">")]),t._v("\n            @"),n("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Auth"),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{attrs:{class:"token punctuation"}},[t._v(":")]),n("span",{attrs:{class:"token function"}},[t._v("check")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n                "),n("span",{attrs:{class:"token operator"}},[t._v("<")]),t._v("div "),n("span",{attrs:{class:"token keyword"}},[t._v("class")]),n("span",{attrs:{class:"token operator"}},[t._v("=")]),n("span",{attrs:{class:"token double-quoted-string string"}},[t._v('"alert alert-danger text-center"')]),n("span",{attrs:{class:"token operator"}},[t._v(">")]),t._v("\n                    当前登录账号无后台访问权限。\n                "),n("span",{attrs:{class:"token operator"}},[t._v("<")]),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("div"),n("span",{attrs:{class:"token operator"}},[t._v(">")]),t._v("\n            @"),n("span",{attrs:{class:"token keyword"}},[t._v("else")]),t._v("\n                "),n("span",{attrs:{class:"token operator"}},[t._v("<")]),t._v("div "),n("span",{attrs:{class:"token keyword"}},[t._v("class")]),n("span",{attrs:{class:"token operator"}},[t._v("=")]),n("span",{attrs:{class:"token double-quoted-string string"}},[t._v('"alert alert-danger text-center"')]),n("span",{attrs:{class:"token operator"}},[t._v(">")]),t._v("\n                    请登录以后再操作\n                "),n("span",{attrs:{class:"token operator"}},[t._v("<")]),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("div"),n("span",{attrs:{class:"token operator"}},[t._v(">")]),t._v("\n\n                "),n("span",{attrs:{class:"token operator"}},[t._v("<")]),t._v("a "),n("span",{attrs:{class:"token keyword"}},[t._v("class")]),n("span",{attrs:{class:"token operator"}},[t._v("=")]),n("span",{attrs:{class:"token double-quoted-string string"}},[t._v('"btn btn-lg btn-primary btn-block"')]),t._v(" href"),n("span",{attrs:{class:"token operator"}},[t._v("=")]),n("span",{attrs:{class:"token double-quoted-string string"}},[t._v("\"{{ route('login') }}\"")]),n("span",{attrs:{class:"token operator"}},[t._v(">")]),t._v("\n                    "),n("span",{attrs:{class:"token operator"}},[t._v("<")]),t._v("span "),n("span",{attrs:{class:"token keyword"}},[t._v("class")]),n("span",{attrs:{class:"token operator"}},[t._v("=")]),n("span",{attrs:{class:"token double-quoted-string string"}},[t._v('"glyphicon glyphicon-log-in"')]),t._v(" aria"),n("span",{attrs:{class:"token operator"}},[t._v("-")]),t._v("hidden"),n("span",{attrs:{class:"token operator"}},[t._v("=")]),n("span",{attrs:{class:"token double-quoted-string string"}},[t._v('"true"')]),n("span",{attrs:{class:"token operator"}},[t._v(">")]),n("span",{attrs:{class:"token operator"}},[t._v("<")]),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("span"),n("span",{attrs:{class:"token operator"}},[t._v(">")]),t._v("\n                    登 录\n                "),n("span",{attrs:{class:"token operator"}},[t._v("<")]),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("a"),n("span",{attrs:{class:"token operator"}},[t._v(">")]),t._v("\n            @"),n("span",{attrs:{class:"token keyword"}},[t._v("endif")]),t._v("\n        "),n("span",{attrs:{class:"token operator"}},[t._v("<")]),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("div"),n("span",{attrs:{class:"token operator"}},[t._v(">")]),t._v("\n    "),n("span",{attrs:{class:"token operator"}},[t._v("<")]),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("div"),n("span",{attrs:{class:"token operator"}},[t._v(">")]),t._v("\n"),n("span",{attrs:{class:"token operator"}},[t._v("<")]),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("div"),n("span",{attrs:{class:"token operator"}},[t._v(">")]),t._v("\n\n@stop\n")])]),n("h3",{attrs:{id:"_5-测试一下"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-测试一下","aria-hidden":"true"}},[t._v("#")]),t._v(" 5. 测试一下")]),n("p",[t._v("分别使用以下三种用户权限尝试：")]),n("ol",[n("li",[t._v("未登录用户；")]),n("li",[t._v("登录无权限用户；")]),n("li",[t._v("最后是站长访问。")])]),n("p",[t._v("示例：")]),n("p",[n("img",{attrs:{src:a(827),alt:"file"}})]),n("h2",{attrs:{id:"后台部分可见"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#后台部分可见","aria-hidden":"true"}},[t._v("#")]),t._v(" 后台部分可见")]),n("p",[n("code",[t._v("administrator.php")]),t._v(" 配置项 "),n("code",[t._v("permission")]),t._v(" 控制的是进入后台的权限，模型配置信息里 "),n("code",[t._v("permission")]),t._v(" 控制的是模型页面的访问权限，如果模型权限未通过，后台菜单项都会隐藏。我们的 1 号用户 Summer 的角色是站长，拥有所有权限，2 号用户是管理员，只拥有管理内容的权限，接下来我们使用 2 号用户来访问后台：")]),n("p",[n("img",{attrs:{src:a(826),alt:"file"}})]),n("p",[t._v("Chrome 浏览器会报错 "),n("code",[t._v("ERR_TOO_MANY_REDIRECTS")]),t._v("，意为太多跳转死循环，页面无法渲染。原因是 "),n("code",[t._v("administrator.php")]),t._v(" 中，我们将 "),n("code",[t._v("home_page")]),t._v(" 选项设置为 "),n("code",[t._v("users")]),t._v(" 页面，当我们使用 2 号用户访问 "),n("code",[t._v("/admin")]),t._v(" 时，会自动跳转到 "),n("code",[t._v("users")]),t._v(" 页面，"),n("code",[t._v("users")]),t._v(" 页面检测到 2 号用户没有访问权限，遂重定向到后台首页 "),n("code",[t._v("/admin")]),t._v(" 中，访问首页又会重定向到 "),n("code",[t._v("users")]),t._v(" 中，所以就是死循环。解决的方法很简单，将 "),n("code",[t._v("home_page")]),t._v(" 选项改为访问权限较低的页面即可：")]),n("p",[n("em",[t._v("config/administrator.php")])]),n("pre",{pre:!0,attrs:{class:"language-php"}},[n("code",[n("span",{attrs:{class:"token php language-php"}},[n("span",{attrs:{class:"token delimiter important"}},[t._v("<?php")]),t._v("\n\n"),n("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("array")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n    "),n("span",{attrs:{class:"token comment"}},[t._v("// 用来作为后台主页的菜单条目，由 `use_dashboard` 选项决定，菜单指的是 `menu` 选项")]),t._v("\n    "),n("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'home_page'")]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),n("span",{attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),n("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'topics'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),n("p",[t._v("修改完成后，当我们再次使用 2 号用户访问后台，会跳转到 "),n("code",[t._v("topics")]),t._v(" 模型管理页面下，菜单里也只有内容管理子菜单，其他无权限的菜单皆隐藏着：")]),n("p",[n("img",{attrs:{src:a(825),alt:"file"}})]),n("h2",{attrs:{id:"git-版本控制"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#git-版本控制","aria-hidden":"true"}},[t._v("#")]),t._v(" Git 版本控制")]),n("p",[t._v("下面把代码纳入到版本管理：")]),n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("$ "),n("span",{attrs:{class:"token function"}},[t._v("git")]),t._v(" add -A\n$ "),n("span",{attrs:{class:"token function"}},[t._v("git")]),t._v(" commit -m "),n("span",{attrs:{class:"token string"}},[t._v('"Admin permissions"')]),t._v("\n")])])])}],o=a(0),r=Object(o.a)({},function(){this.$createElement;this._self._c;return this._m(0)},n,!1,null,null,null);s.default=r.exports},825:function(t,s,a){t.exports=a.p+"assets/img/6.8_4.c4477c74.gif"},826:function(t,s,a){t.exports=a.p+"assets/img/6.8_3.839a781b.gif"},827:function(t,s,a){t.exports=a.p+"assets/img/6.8_2.6e5044e9.gif"},828:function(t,s,a){t.exports=a.p+"assets/img/6.8_1.26e815e6.gif"}}]);