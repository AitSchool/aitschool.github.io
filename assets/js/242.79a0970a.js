(window.webpackJsonp=window.webpackJsonp||[]).push([[242],{1300:function(t,s,a){"use strict";a.r(s);var n=[function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("div",{staticClass:"content"},[n("h1",{attrs:{id:"_8-2-活跃用户接口"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_8-2-活跃用户接口","aria-hidden":"true"}},[t._v("#")]),t._v(" 8.2 活跃用户接口")]),n("p",[t._v("Larabbs 的边栏会显示活跃用户，这一节我们会为这个功能开发接口：")]),n("p",[n("img",{attrs:{src:a(634),alt:"file"}})]),n("h2",{attrs:{id:"_1-生成测试数据"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-生成测试数据","aria-hidden":"true"}},[t._v("#")]),t._v(" 1. 生成测试数据")]),n("p",[t._v("如果你的 Homestead 的 Cron 没有配置，你可能会发现，你本地的 Larabbs 并没有显示活跃用户")]),n("p",[n("img",{attrs:{src:a(633),alt:"file"}})]),n("p",[t._v("这是因为活跃用户数据，是 artisan 命令生成的，如果 Cron 配置正确，会每个小时执行一次，计算出活跃用户。")]),n("h3",{attrs:{id:"算法"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#算法","aria-hidden":"true"}},[t._v("#")]),t._v(" 算法")]),n("p",[t._v("算法参考 Laravel China 社区： "),n("a",{attrs:{href:"https://laravel-china.org/topics/2902/algorithm-for-active-users",target:"_blank",rel:"noopener noreferrer"}},[t._v("关于「活跃用户」的算法")]),t._v("。")]),n("p",[t._v("系统 "),n("strong",[t._v("每一个小时")]),t._v(" 计算一次，统计 "),n("strong",[t._v("最近 7 天")]),t._v(" 所有用户发的 "),n("strong",[t._v("帖子数")]),t._v(" 和 "),n("strong",[t._v("评论数")]),t._v("，用户每发一个帖子则得 "),n("strong",[t._v("4")]),t._v(" 分，每发一个回复得 "),n("strong",[t._v("1")]),t._v(" 分，计算出所有人的『得分』后再倒序，排名前八的用户将会显示在「活跃用户」列表里。")]),n("p",[t._v("假设用户 A 在 7 天内发了 10 篇帖子，发了 5 条评论，则其得分为")]),n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("10 * 4 + 5 * 1 = 45 \n")])]),n("h3",{attrs:{id:"执行-artisan-命令"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#执行-artisan-命令","aria-hidden":"true"}},[t._v("#")]),t._v(" 执行 Artisan 命令")]),n("p",[t._v("由于算法计算的是 7 天内的用户发帖和评论数据，我们可以在填充一些帖子数据")]),n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("$ php artisan db:seed --class"),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v("TopicsTableSeeder\n")])]),n("p",[t._v("执行生成活跃用户命令")]),n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("$ php artisan larabbs:calculate-active-user\n")])]),n("p",[n("img",{attrs:{src:a(632),alt:"file"}})]),n("p",[t._v("再次访问 larabbs.test，应该能看到活跃用户数据了")]),n("p",[n("img",{attrs:{src:a(631),alt:"file"}})]),n("h2",{attrs:{id:"_2-添加路由"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-添加路由","aria-hidden":"true"}},[t._v("#")]),t._v(" 2. 添加路由")]),n("p",[n("em",[t._v("routes/api.php")])]),n("pre",{pre:!0,attrs:{class:"language-php"}},[n("code",[n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token comment"}},[t._v("// 资源推荐")]),t._v("\n"),n("span",{attrs:{class:"token variable"}},[t._v("$api")]),n("span",{attrs:{class:"token operator"}},[t._v("-")]),n("span",{attrs:{class:"token operator"}},[t._v(">")]),n("span",{attrs:{class:"token function"}},[t._v("get")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'links'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'LinksController@index'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),n("span",{attrs:{class:"token operator"}},[t._v("-")]),n("span",{attrs:{class:"token operator"}},[t._v(">")]),n("span",{attrs:{class:"token function"}},[t._v("name")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'api.links.index'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{attrs:{class:"token comment"}},[t._v("// 活跃用户")]),t._v("\n"),n("span",{attrs:{class:"token variable"}},[t._v("$api")]),n("span",{attrs:{class:"token operator"}},[t._v("-")]),n("span",{attrs:{class:"token operator"}},[t._v(">")]),n("span",{attrs:{class:"token function"}},[t._v("get")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'actived/users'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'UsersController@activedIndex'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),n("span",{attrs:{class:"token operator"}},[t._v("-")]),n("span",{attrs:{class:"token operator"}},[t._v(">")]),n("span",{attrs:{class:"token function"}},[t._v("name")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'api.actived.users.index'")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n")])]),n("p",[t._v("该接口也是游客可以访问的。")]),n("h2",{attrs:{id:"_3-修改-controller"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-修改-controller","aria-hidden":"true"}},[t._v("#")]),t._v(" 3. 修改 Controller")]),n("p",[n("em",[t._v("app/Http/Controllers/Api/UsersController.php")])]),n("pre",{pre:!0,attrs:{class:"language-php"}},[n("code",[n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("activedIndex")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("User "),n("span",{attrs:{class:"token variable"}},[t._v("$user")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),n("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),n("span",{attrs:{class:"token variable"}},[t._v("$this")]),n("span",{attrs:{class:"token operator"}},[t._v("-")]),n("span",{attrs:{class:"token operator"}},[t._v(">")]),n("span",{attrs:{class:"token property"}},[t._v("response")]),n("span",{attrs:{class:"token operator"}},[t._v("-")]),n("span",{attrs:{class:"token operator"}},[t._v(">")]),n("span",{attrs:{class:"token function"}},[t._v("collection")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token variable"}},[t._v("$user")]),n("span",{attrs:{class:"token operator"}},[t._v("-")]),n("span",{attrs:{class:"token operator"}},[t._v(">")]),n("span",{attrs:{class:"token function"}},[t._v("getActiveUsers")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),n("span",{attrs:{class:"token class-name"}},[t._v("UserTransformer")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n")])]),n("p",[t._v("可以看到代码非常的简单，直接调用 "),n("code",[t._v("$user->getActiveUsers()")]),t._v(" 即可，活跃用户的逻辑代码放置于在 Trait —— "),n("code",[t._v("app/Models/Traits/ActiveUserHelper.php")]),t._v(" 中，算法的讲解，代码里有注释，这里便不再做过多讲解，购买过第二本教程的用户可以复习一下 "),n("a",{attrs:{href:"https://laravel-china.org/courses/laravel-intermediate-training-5.5/671/active-users#2.%E7%BC%96%E5%86%99%E9%80%BB%E8%BE%91%E4%BB%A3%E7%A0%81",target:"_blank",rel:"noopener noreferrer"}},[t._v("8.1. 边栏活跃用户")]),t._v(" 这一节。")]),n("h2",{attrs:{id:"_4-postman-调试"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-postman-调试","aria-hidden":"true"}},[t._v("#")]),t._v(" 4. PostMan 调试")]),n("p",[n("img",{attrs:{src:a(630),alt:"file"}})]),n("h2",{attrs:{id:"代码版本控制"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#代码版本控制","aria-hidden":"true"}},[t._v("#")]),t._v(" 代码版本控制#")]),n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("$ "),n("span",{attrs:{class:"token function"}},[t._v("git")]),t._v(" add -A\n$ "),n("span",{attrs:{class:"token function"}},[t._v("git")]),t._v(" commit -m "),n("span",{attrs:{class:"token string"}},[t._v("'actived users'")]),t._v("\n")])])])}],r=a(0),e=Object(r.a)({},function(){this.$createElement;this._self._c;return this._m(0)},n,!1,null,null,null);s.default=e.exports},630:function(t,s,a){t.exports=a.p+"assets/img/8.2_5.0c87b2c3.png"},631:function(t,s,a){t.exports=a.p+"assets/img/8.2_4.ad9a4303.png"},632:function(t,s,a){t.exports=a.p+"assets/img/8.2_3.bca4e3d7.png"},633:function(t,s,a){t.exports=a.p+"assets/img/8.2_2.e5a903da.png"},634:function(t,s,a){t.exports=a.p+"assets/img/8.2_1.ad9a4303.png"}}]);